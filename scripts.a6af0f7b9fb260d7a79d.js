var repListnner;function FloorPlannerLib(){setTimeout((function(){document.querySelector("#lin").addEventListener("mouseup",(function(e){if(showRib&&$("#boxScale").show(200),t="off",R("default"),"select_mode"==r&&"undefined"!=typeof binder&&(binder.remove(),delete binder,p()),"text_mode"==r&&0==n&&(n=1,$("#textToLayer").modal()),"object_mode"==r){OBJDATA.push(binder),binder.graph.remove();var o="boxcarpentry";"energy"==OBJDATA[OBJDATA.length-1].class&&(o="boxEnergy"),"furniture"==OBJDATA[OBJDATA.length-1].class&&(o="boxFurniture"),$("#"+o).append(OBJDATA[OBJDATA.length-1].graph),delete binder,$("#boxinfo").html("Object added"),D("select_mode"),p()}if("distance_mode"==r&&1==n){n=0;var i=labelMeasure.get(0).getBoundingClientRect();i.x=i.x*h-a.left*h+d,i.y=i.y*h-a.top*h+c,i.origin={x:i.x+i.width/2,y:i.y+i.height/2},binder.bbox=i,binder.realBbox=[{x:binder.bbox.x,y:binder.bbox.y},{x:binder.bbox.x+binder.bbox.width,y:binder.bbox.y},{x:binder.bbox.x+binder.bbox.width,y:binder.bbox.y+binder.bbox.height},{x:binder.bbox.x,y:binder.bbox.y+binder.bbox.height}],binder.size=binder.bbox.width,binder.thick=binder.bbox.height,binder.graph.append(labelMeasure),OBJDATA.push(binder),binder.graph.remove(),$("#boxcarpentry").append(OBJDATA[OBJDATA.length-1].graph),delete binder,delete labelMeasure,cross.remove(),delete cross,$("#boxinfo").html("Measure added"),D("select_mode"),p()}if("room_mode"==r){if("undefined"==typeof binder)return!1;var s=binder.area/3600;binder.attr({fill:"none",stroke:"#ddf00a","stroke-width":7}),$(".size").html(s.toFixed(2)+" m²"),$("#roomIndex").val(binder.id),""!=ROOM[binder.id].surface?$("#roomSurface").val(ROOM[binder.id].surface):$("#roomSurface").val(""),document.querySelector("#seeArea").checked=ROOM[binder.id].showSurface,document.querySelector("#roomBackground").value=ROOM[binder.id].color;var l=ROOM[binder.id].name;document.querySelector("#roomName").value=l,""!=ROOM[binder.id].name?document.querySelector("#roomLabel").innerHTML=l+' <span class="caret"></span>':document.querySelector("#roomLabel").innerHTML='None <span class="caret"></span>';var u=ROOM[binder.id].action;document.querySelector("#"+u+"Action").checked=!0,$("#panel").hide(100),$("#roomTools").show("300",(function(){$("#lin").css("cursor","default"),$("#boxinfo").html("Config. the room")})),r="edit_room_mode",p()}if("node_mode"==r){if("undefined"!=typeof binder){var m=new T.wall({x:binder.data.x,y:binder.data.y},binder.data.wall.end,"normal",binder.data.wall.thick);WALLS.push(m),binder.data.wall.end={x:binder.data.x,y:binder.data.y},binder.remove(),delete binder,T.architect(WALLS),p()}D("select_mode")}if("door_mode"==r){if("undefined"==typeof binder)return $("#boxinfo").html("The plan currently contains no wall."),D("select_mode"),!1;OBJDATA.push(binder),binder.graph.remove(),$("#boxcarpentry").append(OBJDATA[OBJDATA.length-1].graph),delete binder,$("#boxinfo").html("Element added"),D("select_mode"),p()}if("line_mode"==r||"partition_mode"==r){$("#linetemp").remove(),W();var b=qSVG.measure({x:x,y:y},{x:pox,y:poy});if(b/=meter,$("#line_construc").length&&b>.3){b=wallSize,"partition_mode"==r&&(b=partitionSize);var f=new T.wall({x:pox,y:poy},{x:x,y:y},"normal",b);WALLS.push(f),T.architect(WALLS),document.getElementById("multi").checked&&!wallEndConstruc?(R("validation"),n=1):n=0,$("#boxinfo").html("Wall added <span style='font-size:0.6em'>Moy. "+(qSVG.measure({x:pox,y:poy},{x:x,y:y})/60).toFixed(2)+" m</span>"),$("#line_construc").remove(),lengthTemp.remove(),delete lengthTemp,wallEndConstruc&&(n=0),delete wallEndConstruc,pox=x,poy=y,p()}else n=0,$("#boxinfo").html("Select mode"),D("select_mode"),"undefined"!=typeof binder&&(binder.remove(),delete binder),snap=k(e,grid_snap),pox=snap.x,poy=snap.y}if("bind_mode"==r){if(n=0,"undefined"!=typeof binder){if(D("select_mode"),binder,"segment"==binder.type){var L=!1;if(binder.wall.start==binder.before&&(L=!0),L){$("#panel").hide(100);var g=T.objFromWall(wallBind);$("#boxinfo").html('Modify a wall<br/><span style="font-size:0.7em;color:#de9b43">This wall can\'t become a separation (contains doors or windows) !</span>'),g.length>0?$("#separate").hide():"separate"==binder.wall.type?($("#separate").hide(),$("#rangeThick").hide(),$("#recombine").show(),$("#cutWall").hide(),document.getElementById("titleWallTools").textContent="Modify the separation"):($("#cutWall").show(),$("#separate").show(),$("#rangeThick").show(),$("#recombine").hide(),document.getElementById("titleWallTools").textContent="Modify the wall",$("#boxinfo").html("Modify the wall")),$("#wallTools").show(200),document.getElementById("wallWidth").setAttribute("min",7),document.getElementById("wallWidth").setAttribute("max",50),document.getElementById("wallWidthScale").textContent="7-50",document.getElementById("wallWidth").value=binder.wall.thick,document.getElementById("wallWidthVal").textContent=binder.wall.thick,r="edit_wall_mode"}delete equation1,delete equation2,delete equation3,delete intersectionFollowers}if("obj"==binder.type&&((S=Math.abs(binder.oldXY.x-binder.x)+Math.abs(binder.oldXY.y-binder.y))<1?($("#panel").hide(100),$("#objTools").show("200",(function(){$("#lin").css("cursor","default"),$("#boxinfo").html("Config. the door/window"),document.getElementById("doorWindowWidth").setAttribute("min",binder.obj.params.resizeLimit.width.min),document.getElementById("doorWindowWidth").setAttribute("max",binder.obj.params.resizeLimit.width.max),document.getElementById("doorWindowWidthScale").textContent=binder.obj.params.resizeLimit.width.min+"-"+binder.obj.params.resizeLimit.width.max,document.getElementById("doorWindowWidth").value=binder.obj.size,document.getElementById("doorWindowWidthVal").textContent=binder.obj.size})),r="edit_door_mode"):(r="select_mode",n=0,binder.graph.remove(),delete binder)),"undefined"!=typeof binder&&"boundingBox"==binder.type){var S=Math.abs(binder.oldX-binder.x)+Math.abs(binder.oldY-binder.y),A=binder.obj;A.params.move||(A.graph.remove(),OBJDATA.splice(OBJDATA.indexOf(A),1),$("#boxinfo").html("Measure deleted !")),S<1&&A.params.move?(A.params.resize?$("#objBoundingBoxScale").show():$("#objBoundingBoxScale").hide(),A.params.rotate?$("#objBoundingBoxRotation").show():$("#objBoundingBoxRotation").hide(),$("#panel").hide(100),$("#objBoundingBox").show("200",(function(){$("#lin").css("cursor","default"),$("#boxinfo").html("Modify the object"),document.getElementById("bboxWidth").setAttribute("min",A.params.resizeLimit.width.min),document.getElementById("bboxWidth").setAttribute("max",A.params.resizeLimit.width.max),document.getElementById("bboxWidthScale").textContent=A.params.resizeLimit.width.min+"-"+A.params.resizeLimit.height.max,document.getElementById("bboxHeight").setAttribute("min",A.params.resizeLimit.height.min),document.getElementById("bboxHeight").setAttribute("max",A.params.resizeLimit.height.max),document.getElementById("bboxHeightScale").textContent=A.params.resizeLimit.height.min+"-"+A.params.resizeLimit.height.max,$("#stepsCounter").hide(),"stair"==A.class&&(document.getElementById("bboxStepsVal").textContent=A.value,$("#stepsCounter").show()),document.getElementById("bboxWidth").value=100*A.width,document.getElementById("bboxWidthVal").textContent=100*A.width,document.getElementById("bboxHeight").value=100*A.height,document.getElementById("bboxHeightVal").textContent=100*A.height,document.getElementById("bboxRotation").value=A.angle,document.getElementById("bboxRotationVal").textContent=A.angle})),r="edit_boundingBox_mode"):(r="select_mode",n=0,binder.graph.remove(),delete binder)}"bind_mode"==r&&(binder.remove(),delete binder)}p()}"edit_room_mode"!=r&&(T.showScaleBox(),B())})),document.querySelector("#lin").addEventListener("mousemove",f((function(a){!function(a){if(a.preventDefault(),$(".sub").hide(100),"text_mode"==r&&(snap=k(a,grid_snap),R(0==n?"text":"none")),"object_mode"==r)if(snap=k(a,grid_snap),"undefined"==typeof binder)$("#object_list").hide(200),binder="simpleStair"==e?new T.obj2D("free","stair","simpleStair",snap,0,0,0,"normal",0,15):new T.obj2D("free","energy",e,snap,0,0,0,"normal",0),$("#boxbind").append(binder.graph);else{if(("stick"!=binder.family&&"collision"!=binder.family||0==WALLS.length)&&(binder.x=snap.x,binder.y=snap.y,binder.oldX=binder.x,binder.oldY=binder.y,binder.update()),"collision"==binder.family){var i=!1;T.rayCastingWalls({x:binder.bbox.left,y:binder.bbox.top})&&(i=!0),!i&&T.rayCastingWalls({x:binder.bbox.left,y:binder.bbox.bottom})&&(i=!0),!i&&T.rayCastingWalls({x:binder.bbox.right,y:binder.bbox.top})&&(i=!0),!i&&T.rayCastingWalls({x:binder.bbox.right,y:binder.bbox.bottom})&&(i=!0),i?(binder.x=binder.oldX,binder.y=binder.oldY,binder.update()):(binder.x=snap.x,binder.y=snap.y,binder.oldX=binder.x,binder.oldY=binder.y,binder.update())}if("stick"==binder.family){pos=T.stickOnWall(snap),binder.oldX=pos.x,binder.oldY=pos.y;var s=qSVG.angleDeg(pos.wall.start.x,pos.wall.start.y,pos.wall.end.x,pos.wall.end.y),l=qSVG.vectorXY({x:pos.wall.start.x,y:pos.wall.start.y},{x:pos.wall.end.x,y:pos.wall.end.y}),d=qSVG.vectorXY({x:pos.wall.end.x,y:pos.wall.end.y},snap);binder.x=pos.x-Math.sin(pos.wall.angle*(180*Math.PI))*binder.thick/2,binder.y=pos.y-Math.cos(pos.wall.angle*(180*Math.PI))*binder.thick/2;var c=qSVG.vectorDeter(l,d);1==Math.sign(c)&&(s+=180,binder.x=pos.x+Math.sin(pos.wall.angle*(180*Math.PI))*binder.thick/2,binder.y=pos.y+Math.cos(pos.wall.angle*(180*Math.PI))*binder.thick/2),binder.angle=s,binder.update()}}if("distance_mode"==r)if(snap=k(a,grid_snap),"undefined"==typeof binder)cross=qSVG.create("boxbind","path",{d:"M-3000,0 L3000,0 M0,-3000 L0,3000","stroke-width":.5,"stroke-opacity":"0.8",stroke:"#e2b653",fill:"#e2b653"}),binder=new T.obj2D("free","measure","",{x:0,y:0},0,0,0,"normal",0,""),labelMeasure=qSVG.create("none","text",{x:0,y:-10,"font-size":"1.2em",stroke:"#ffffff","stroke-width":"0.4px","font-family":"roboto","text-anchor":"middle",fill:"#3672d9"}),binder.graph.append(labelMeasure),$("#boxbind").append(binder.graph);else if(x=snap.x,y=snap.y,cross.attr({transform:"translate("+snap.x+","+snap.y+")"}),1==n){var u=qSVG.middle(pox,poy,x,y),p=qSVG.angle(pox,poy,x,y),m=qSVG.measure({x:pox,y:poy},{x:x,y:y});binder.size=m,binder.x=u.x,binder.y=u.y,binder.angle=p.deg,m=(m/meter).toFixed(2)+" m",labelMeasure.context.textContent=m,binder.update()}var f;if("room_mode"==r)if(snap=k(a,grid_snap),f=T.rayCastingRoom(snap)){"undefined"!=typeof binder&&(binder.remove(),delete binder);for(var L=f.coords,g="M"+L[0].x+","+L[0].y,S=1;S<L.length-1;S++)g=g+" L"+L[S].x+","+L[S].y;if(g+="Z",f.inside.length>0)for(var A=0;A<f.inside.length;A++){g=g+" M"+Rooms.polygons[f.inside[A]].coords[Rooms.polygons[f.inside[A]].coords.length-1].x+","+Rooms.polygons[f.inside[A]].coords[Rooms.polygons[f.inside[A]].coords.length-1].y;for(var w=Rooms.polygons[f.inside[A]].coords.length-2;w>-1;w--)g=g+" L"+Rooms.polygons[f.inside[A]].coords[w].x+","+Rooms.polygons[f.inside[A]].coords[w].y}binder=qSVG.create("boxbind","path",{id:"roomSelected",d:g,fill:"#c9c14c","fill-opacity":.5,stroke:"#c9c14c","fill-rule":"evenodd","stroke-width":3}),binder.type="room",binder.area=f.area,binder.id=ROOM.indexOf(f)}else"undefined"!=typeof binder&&(binder.remove(),delete binder);if("door_mode"==r)if(snap=k(a,grid_snap),wallSelect=T.nearWall(snap)){if("separate"!=(oe=wallSelect.wall).type)if("undefined"==typeof binder){binder=new T.obj2D("inWall","doorWindow",e,wallSelect,0,0,60,"normal",oe.thick),s=qSVG.angleDeg(oe.start.x,oe.start.y,oe.end.x,oe.end.y),l=qSVG.vectorXY({x:oe.start.x,y:oe.start.y},{x:oe.end.x,y:oe.end.y}),d=qSVG.vectorXY({x:oe.end.x,y:oe.end.y},snap),c=qSVG.vectorDeter(l,d),1==Math.sign(c)&&(s+=180,binder.angleSign=1);var v=qSVG.middle(oe.start.x,oe.start.y,oe.end.x,oe.end.y);binder.x=v.x,binder.y=v.y,binder.angle=s,binder.update(),$("#boxbind").append(binder.graph)}else{s=qSVG.angleDeg(oe.start.x,oe.start.y,oe.end.x,oe.end.y),l=qSVG.vectorXY({x:oe.start.x,y:oe.start.y},{x:oe.end.x,y:oe.end.y}),d=qSVG.vectorXY({x:oe.end.x,y:oe.end.y},snap),c=qSVG.vectorDeter(l,d),binder.angleSign=0,1==Math.sign(c)&&(binder.angleSign=1,s+=180);var V=q(oe.equations.base,binder.size,wallSelect);qSVG.btwn(V[0].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[0].y,oe.start.y,oe.end.y)&&qSVG.btwn(V[1].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[1].y,oe.start.y,oe.end.y)&&(binder.x=wallSelect.x,binder.y=wallSelect.y,binder.angle=s,binder.thick=oe.thick,binder.limit=V,binder.update()),(wallSelect.x==oe.start.x&&wallSelect.y==oe.start.y||wallSelect.x==oe.end.x&&wallSelect.y==oe.end.y)&&(qSVG.btwn(V[0].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[0].y,oe.start.y,oe.end.y)&&(binder.x=V[0].x,binder.y=V[0].y),qSVG.btwn(V[1].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[1].y,oe.start.y,oe.end.y)&&(binder.x=V[1].x,binder.y=V[1].y),binder.limit=V,binder.angle=s,binder.thick=oe.thick,binder.update())}}else"undefined"!=typeof binder&&(binder.graph.remove(),delete binder);if("node_mode"==r)if(snap=k(a,grid_snap),"undefined"==typeof binder){if(addNode=T.nearWall(snap,30)){var D=addNode.wall.end.x,C=addNode.wall.end.y,_=addNode.wall.start.x,I=addNode.wall.start.y;s=qSVG.angle(_,I,D,C),binder=qSVG.create("boxbind","path",{id:"circlebinder",d:"M-20,-10 L-13,0 L-20,10 Z M-13,0 L13,0 M13,0 L20,-10 L20,10 Z",stroke:"#5cba79",fill:"#5cba79","stroke-width":"1.5px"}),binder.attr({transform:"translate("+addNode.x+","+addNode.y+") rotate("+(s.deg+90)+",0,0)"}),binder.data=addNode,binder.x1=_,binder.x2=D,binder.y1=I,binder.y2=C}}else(addNode=T.nearWall(snap,30))&&addNode?(D=addNode.wall.end.x,C=addNode.wall.end.y,_=addNode.wall.start.x,I=addNode.wall.start.y,s=qSVG.angle(_,I,D,C),binder.attr({transform:"translate("+addNode.x+","+addNode.y+") rotate("+(s.deg+90)+",0,0)"}),binder.data=addNode):(binder.remove(),delete binder);if("select_mode"==r&&"off"==t){snap=k(a,"off");for(var j=!1,z=0;z<OBJDATA.length;z++){OBJDATA,OBJDATA,OBJDATA,OBJDATA;var N=OBJDATA[z].realBbox;qSVG.rayCasting(snap,N)&&(j=OBJDATA[z])}if(!1!==j)if("undefined"!=typeof binder&&"segment"==binder.type&&(binder.graph.remove(),delete binder,R("default")),j.params.bindBox)"undefined"==typeof binder&&(binder=new T.obj2D("free","boundingBox","",j.bbox.origin,j.angle,0,j.size,"normal",j.thick,j.realBbox),binder.update(),binder.obj=j,binder.type="boundingBox",binder.oldX=binder.x,binder.oldY=binder.y,$("#boxbind").append(binder.graph),j.params.move||R("trash"),j.params.move&&R("move"));else if("undefined"==typeof binder){var F=T.rayCastingWall(j);F.length>1&&(F=F[0]),E(F),binder=new T.obj2D("inWall","socle","",j,j.angle,0,j.size,"normal",F.thick),binder.update(),binder.oldXY={x:j.x,y:j.y},$("#boxbind").append(binder.graph)}else a.target==binder.graph.get(0).firstChild?(R("move"),binder.graph.get(0).firstChild.setAttribute("class","circle_css_2"),binder.type="obj",binder.obj=j):(R("default"),binder.graph.get(0).firstChild.setAttribute("class","circle_css_1"),binder.type=!1);else"undefined"!=typeof binder&&(void 0!==binder.graph?binder.graph.remove():binder.remove(),delete binder,R("default"),B());if((wallNode=T.nearWallNode(snap,20))?("undefined"!=typeof binder&&"segment"!=binder.type||(binder=qSVG.create("boxbind","circle",{id:"circlebinder",class:"circle_css_2",cx:wallNode.x,cy:wallNode.y,r:o}),binder.data=wallNode,binder.type="node",$("#linebinder").length&&$("#linebinder").remove()),R("move")):"undefined"!=typeof binder&&"node"==binder.type&&(binder.remove(),delete binder,G(),R("default"),B()),wallBind=T.rayCastingWalls(snap,WALLS)){if(wallBind.length>1&&(wallBind=wallBind[wallBind.length-1]),wallBind&&"undefined"==typeof binder){(me=T.objFromWall(wallBind)).length>0&&T.inWallRib2(wallBind),binder={},binder.wall=wallBind,E(binder.wall);var J=qSVG.create("none","line",{x1:binder.wall.start.x,y1:binder.wall.start.y,x2:binder.wall.end.x,y2:binder.wall.end.y,"stroke-width":5,stroke:"#5cba79"}),P=qSVG.create("none","circle",{class:"circle_css",cx:binder.wall.start.x,cy:binder.wall.start.y,r:o/1.8}),H=qSVG.create("none","circle",{class:"circle_css",cx:binder.wall.end.x,cy:binder.wall.end.y,r:o/1.8});binder.graph=qSVG.create("none","g"),binder.graph.append(J),binder.graph.append(P),binder.graph.append(H),$("#boxbind").append(binder.graph),binder.type="segment",R("pointer")}}else(wallBind=T.nearWall(snap,6))?wallBind&&"undefined"==typeof binder&&(wallBind=wallBind.wall,(me=T.objFromWall(wallBind)).length>0&&T.inWallRib2(wallBind),binder={},binder.wall=wallBind,E(binder.wall),J=qSVG.create("none","line",{x1:binder.wall.start.x,y1:binder.wall.start.y,x2:binder.wall.end.x,y2:binder.wall.end.y,"stroke-width":5,stroke:"#5cba79"}),P=qSVG.create("none","circle",{class:"circle_css",cx:binder.wall.start.x,cy:binder.wall.start.y,r:o/1.8}),H=qSVG.create("none","circle",{class:"circle_css",cx:binder.wall.end.x,cy:binder.wall.end.y,r:o/1.8}),binder.graph=qSVG.create("none","g"),binder.graph.append(J),binder.graph.append(P),binder.graph.append(H),$("#boxbind").append(binder.graph),binder.type="segment",R("pointer")):"undefined"!=typeof binder&&"segment"==binder.type&&(binder.graph.remove(),delete binder,G(),R("default"),B())}if("line_mode"!=r&&"partition_mode"!=r||0!=n||(snap=k(a,"off"),R("grab"),pox=snap.x,poy=snap.y,(helpConstruc=M(snap,25))&&(helpConstruc.distance<10?(pox=helpConstruc.x,poy=helpConstruc.y,R("grab")):R("crosshair")),(wallNode=T.nearWallNode(snap,20))?(pox=wallNode.x,poy=wallNode.y,R("grab"),"undefined"==typeof binder&&(binder=qSVG.create("boxbind","circle",{id:"circlebinder",class:"circle_css_2",cx:wallNode.x,cy:wallNode.y,r:o/1.5})),W()):(helpConstruc||R("crosshair"),"undefined"!=typeof binder&&(binder.graph?binder.graph.remove():binder.remove(),delete binder))),1==n&&("line_mode"==r||"partition_mode"==r)&&(snap=k(a,grid_snap),x=snap.x,y=snap.y,starter=minMoveGrid(snap),$("#line_construc").length||((wallNode=T.nearWallNode(snap,20))?(pox=wallNode.x,poy=wallNode.y,wallStartConstruc=!1,wallNode.bestWall==WALLS.length-1?R("validation"):R("grab")):R("crosshair")),starter>grid))if($("#line_construc").length){$("#linetemp").attr({x2:x,y2:y}),(helpConstrucEnd=M(snap,10))&&(x=helpConstrucEnd.x,y=helpConstrucEnd.y),(wallEndConstruc=T.nearWall(snap,12))?(x=wallEndConstruc.x,y=wallEndConstruc.y,R("grab")):R("crosshair"),(wallNode=T.nearWallNode(snap,20))?("undefined"==typeof binder&&(binder=qSVG.create("boxbind","circle",{id:"circlebinder",class:"circle_css_2",cx:wallNode.x,cy:wallNode.y,r:o/1.5})),$("#line_construc").attr({x2:wallNode.x,y2:wallNode.y}),x=wallNode.x,y=wallNode.y,wallEndConstruc=!0,W(),wallNode.bestWall==WALLS.length-1&&document.getElementById("multi").checked?R("validation"):R("grab")):("undefined"!=typeof binder&&(binder.remove(),delete binder),!1===wallEndConstruc&&R("crosshair"));var Y=qSVG.angle(pox,poy,x,y),Z=Math.abs(Y.deg),X=Y.deg/Z,U=poy-X*pox,K=(y-U)/X;"undefined"==typeof binder&&(i=!1,Z<15&&Math.abs(poy-y)<25&&(y=poy,i=!0),Z>75&&Math.abs(pox-x)<25&&(x=pox,i=!0),Z<55&&Z>35&&Math.abs(K-x)<20&&(x=K,i=!0),i?$("#line_construc").attr({"stroke-opacity":1}):$("#line_construc").attr({"stroke-opacity":.7})),$("#line_construc").attr({x2:x,y2:y}),u=qSVG.middle(pox,poy,x,y),p=qSVG.angle(pox,poy,x,y),m=(qSVG.measure({x:pox,y:poy},{x:x,y:y})/60).toFixed(2),"undefined"==typeof lengthTemp&&(lengthTemp=document.createElementNS("http://www.w3.org/2000/svg","text"),lengthTemp.setAttributeNS(null,"x",u.x),lengthTemp.setAttributeNS(null,"y",u.y-15),lengthTemp.setAttributeNS(null,"text-anchor","middle"),lengthTemp.setAttributeNS(null,"stroke","none"),lengthTemp.setAttributeNS(null,"stroke-width","0.6px"),lengthTemp.setAttributeNS(null,"fill","#777777"),lengthTemp.textContent=m+"m",$("#boxbind").append(lengthTemp)),"undefined"!=typeof lengthTemp&&m>.1&&(lengthTemp.setAttributeNS(null,"x",u.x),lengthTemp.setAttributeNS(null,"y",u.y-15),lengthTemp.setAttribute("transform","rotate("+p.deg+" "+u.x+","+u.y+")"),lengthTemp.textContent=m+" m"),"undefined"!=typeof lengthTemp&&m<.1&&(lengthTemp.textContent="")}else{var Q=20;"partition_mode"==r&&(Q=10),lineconstruc=qSVG.create("boxbind","line",{id:"line_construc",x1:pox,y1:poy,x2:x,y2:y,"stroke-width":Q,"stroke-linecap":"butt","stroke-opacity":.7,stroke:"#9fb2e2"}),svgadd=qSVG.create("boxbind","line",{id:"linetemp",x1:pox,y1:poy,x2:x,y2:y,stroke:"transparent","stroke-width":.5,"stroke-opacity":"0.9"})}if("bind_mode"==r){if(snap=k(a,grid_snap),"node"==binder.type){var ee=snap,te=!1;for(var ne in wallListRun)b(wallListRun[ne].end,binder.data)&&(Math.abs(wallListRun[ne].start.x-snap.x)<20&&(ee.x=wallListRun[ne].start.x,te="H"),Math.abs(wallListRun[ne].start.y-snap.y)<20&&(ee.y=wallListRun[ne].start.y,te="V")),b(wallListRun[ne].start,binder.data)&&(Math.abs(wallListRun[ne].end.x-snap.x)<20&&(ee.x=wallListRun[ne].end.x,te="H"),Math.abs(wallListRun[ne].end.y-snap.y)<20&&(ee.y=wallListRun[ne].end.y,te="V"));for(var ne in(nodeMove=T.nearWallNode(snap,15,wallListRun))?(ee.x=nodeMove.x,ee.y=nodeMove.y,$("#circlebinder").attr({class:"circleGum",cx:ee.x,cy:ee.y}),R("grab")):(0!=te&&("H"==te?snap.x=ee.x:snap.y=ee.y),(helpConstruc=M(snap,10,wallListRun))?(ee.x=helpConstruc.x,ee.y=helpConstruc.y,snap.x=helpConstruc.x,snap.y=helpConstruc.y,0!=te&&("H"==te?snap.x=ee.x:snap.y=ee.y),R("grab")):R("move"),$("#circlebinder").attr({class:"circle_css",cx:ee.x,cy:ee.y})),wallListRun)b(wallListRun[ne].start,binder.data)&&(wallListRun[ne].start.x=ee.x,wallListRun[ne].start.y=ee.y),b(wallListRun[ne].end,binder.data)&&(wallListRun[ne].end.x=ee.x,wallListRun[ne].end.y=ee.y);for(var ne in binder.data=ee,T.wallsComputing(WALLS,!1),wallListObj){var oe=wallListObj[ne].wall,re=(j=wallListObj[ne].obj,s=qSVG.angleDeg(oe.start.x,oe.start.y,oe.end.x,oe.end.y),V=q(oe.equations.base,2*wallListObj[ne].distance,wallListObj[ne].from),0);qSVG.btwn(V[1].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[1].y,oe.start.y,oe.end.y)&&(re=1),j.x=V[re].x,j.y=V[re].y,j.angle=s,1==j.angleSign&&(j.angle=s+180);var ae=q(oe.equations.base,j.size,j);qSVG.btwn(ae[0].x,oe.start.x,oe.end.x)&&qSVG.btwn(ae[0].y,oe.start.y,oe.end.y)&&qSVG.btwn(ae[1].x,oe.start.x,oe.end.x)&&qSVG.btwn(ae[1].y,oe.start.y,oe.end.y)?(j.limit=ae,j.update()):(j.graph.remove(),delete j,OBJDATA.splice(oe.indexObj,1),wallListObj.splice(ne,1))}$("#boxRoom").empty(),$("#boxSurface").empty(),Rooms=qSVG.polygonize(WALLS),T.roomMaker(Rooms)}if("segment"==binder.type&&1==n){B(),"v"==equation2.A?equation2.B=snap.x:"h"==equation2.A?equation2.B=snap.y:equation2.B=snap.y-snap.x*equation2.A;var ie=qSVG.intersectionOfEquations(equation1,equation2,"obj"),se=qSVG.intersectionOfEquations(equation2,equation3,"obj");if(qSVG.intersectionOfEquations(equation1,equation3,"obj"),null!=binder.wall.parent&&(b(binder.wall.parent.end,binder.wall.start)?binder.wall.parent.end=ie:b(binder.wall.parent.start,binder.wall.start)?binder.wall.parent.start=ie:binder.wall.parent.end=ie),null!=binder.wall.child&&(b(binder.wall.child.start,binder.wall.end)?binder.wall.child.start=se:b(binder.wall.child.end,binder.wall.end)?binder.wall.child.end=se:binder.wall.child.start=se),binder.wall.start=ie,binder.wall.end=se,binder.graph[0].children[0].setAttribute("x1",ie.x),binder.graph[0].children[0].setAttribute("x2",se.x),binder.graph[0].children[0].setAttribute("y1",ie.y),binder.graph[0].children[0].setAttribute("y2",se.y),binder.graph[0].children[1].setAttribute("cx",ie.x),binder.graph[0].children[1].setAttribute("cy",ie.y),binder.graph[0].children[2].setAttribute("cx",se.x),binder.graph[0].children[2].setAttribute("cy",se.y),null!=equation1.follow)if(qSVG.rayCasting(ie,equation1.backUp.coords))equation1.follow.end=equation1.backUp.end,equation1.follow.start=equation1.backUp.start;else{var le=qSVG.gap(equation1.backUp.start,ie),de=qSVG.gap(equation1.backUp.end,ie);le>de?equation1.follow.end=ie:equation1.follow.start=ie}for(null!=equation3.follow&&(qSVG.rayCasting(se,equation3.backUp.coords)?(equation3.follow.end=equation3.backUp.end,equation3.follow.start=equation3.backUp.start):(le=qSVG.gap(equation3.backUp.start,se))>(de=qSVG.gap(equation3.backUp.end,se))?equation3.follow.end=se:equation3.follow.start=se),z=0;z<equationFollowers.length;z++){var ce=qSVG.intersectionOfEquations(equationFollowers[z].eq,equation2,"obj");if(qSVG.btwn(ce.x,binder.wall.start.x,binder.wall.end.x,"round")&&qSVG.btwn(ce.y,binder.wall.start.y,binder.wall.end.y,"round")){var ue=qSVG.measure(equationFollowers[z].wall.start,equationFollowers[z].wall.end);"start"==equationFollowers[z].type&&(equationFollowers[z].wall.start=ce,ue<5&&null==equationFollowers[z].wall.child&&(WALLS.splice(WALLS.indexOf(equationFollowers[z].wall),1),equationFollowers.splice(z,1))),"end"==equationFollowers[z].type&&(equationFollowers[z].wall.end=ce,ue<5&&null==equationFollowers[z].wall.parent&&(WALLS.splice(WALLS.indexOf(equationFollowers[z].wall),1),equationFollowers.splice(z,1)))}}T.wallsComputing(WALLS,"move"),Rooms=qSVG.polygonize(WALLS);for(var he=0;he<equationsObj.length;he++){j=equationsObj[he].obj;var pe=qSVG.intersectionOfEquations(equationsObj[he].eq,equation2);j.x=pe[0],j.y=pe[1],V=q(equation2,j.size,j),qSVG.btwn(V[0].x,binder.wall.start.x,binder.wall.end.x)&&qSVG.btwn(V[0].y,binder.wall.start.y,binder.wall.end.y)&&qSVG.btwn(V[1].x,binder.wall.start.x,binder.wall.end.x)&&qSVG.btwn(V[1].y,binder.wall.start.y,binder.wall.end.y)&&(j.limit=V,j.update())}for(var ne in WALLS){var me=T.objFromWall(WALLS[ne]);for(var be in me)if(j=me[be],V=q(T.createEquationFromWall(WALLS[ne]),j.size,j),!(qSVG.btwn(V[0].x,WALLS[ne].start.x,WALLS[ne].end.x)&&qSVG.btwn(V[0].y,WALLS[ne].start.y,WALLS[ne].end.y)&&qSVG.btwn(V[1].x,WALLS[ne].start.x,WALLS[ne].end.x)&&qSVG.btwn(V[1].y,WALLS[ne].start.y,WALLS[ne].end.y))){j.graph.remove(),delete j;var ye=OBJDATA.indexOf(j);OBJDATA.splice(ye,1)}}for(equationsObj=[],me=T.objFromWall(binder.wall),be=0;be<me.length;be++)j=me[be],equationsObj.push({obj:j,wall:binder.wall,eq:qSVG.perpendicularEquation(equation2,j.x,j.y)});$("#boxRoom").empty(),$("#boxSurface").empty(),T.roomMaker(Rooms),$("#lin").css("cursor","pointer")}"boundingBox"==binder.type&&1==n&&binder.obj.params.move&&(binder.x=snap.x,binder.y=snap.y,binder.obj.x=snap.x,binder.obj.y=snap.y,binder.obj.update(),binder.update()),"obj"==binder.type&&1==n&&(wallSelect=T.nearWall(snap))&&"separate"!=wallSelect.wall.type&&(E(wallSelect.wall),j=binder.obj,oe=wallSelect.wall,s=qSVG.angleDeg(oe.start.x,oe.start.y,oe.end.x,oe.end.y),l=qSVG.vectorXY({x:oe.start.x,y:oe.start.y},{x:oe.end.x,y:oe.end.y}),d=qSVG.vectorXY({x:oe.end.x,y:oe.end.y},snap),c=qSVG.vectorDeter(l,d),binder.angleSign=0,j.angleSign=0,1==Math.sign(c)&&(s+=180,binder.angleSign=1,j.angleSign=1),V=q(oe.equations.base,binder.size,wallSelect),qSVG.btwn(V[0].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[0].y,oe.start.y,oe.end.y)&&qSVG.btwn(V[1].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[1].y,oe.start.y,oe.end.y)&&(binder.x=wallSelect.x,binder.y=wallSelect.y,binder.angle=s,binder.thick=oe.thick,j.x=wallSelect.x,j.y=wallSelect.y,j.angle=s,j.thick=oe.thick,j.limit=V,binder.update(),j.update()),(wallSelect.x==oe.start.x&&wallSelect.y==oe.start.y||wallSelect.x==oe.end.x&&wallSelect.y==oe.end.y)&&(qSVG.btwn(V[0].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[0].y,oe.start.y,oe.end.y)&&(binder.x=V[0].x,binder.y=V[0].y,j.x=V[0].x,j.y=V[0].y,j.limit=V),qSVG.btwn(V[1].x,oe.start.x,oe.end.x)&&qSVG.btwn(V[1].y,oe.start.y,oe.end.y)&&(binder.x=V[1].x,binder.y=V[1].y,j.x=V[1].x,j.y=V[1].y,j.limit=V),binder.angle=s,binder.thick=oe.thick,j.angle=s,j.thick=oe.thick,binder.update(),j.update())),"obj"!=binder.type&&"segment"!=binder.type&&B()}"select_mode"==r&&"on"==t&&(snap=k(a,grid_snap),$("#lin").css("cursor","move"),distX=(snap.xMouse-pox)*h,distY=(snap.yMouse-poy)*h,O("zoomdrag",distX,distY))}(a)}),30)),document.querySelector("#lin").addEventListener("mousedown",(function(e){if(e.preventDefault(),"distance_mode"==r&&0==n&&(n=1,snap=k(e,grid_snap),pox=snap.x,poy=snap.y),"line_mode"!=r&&"partition_mode"!=r||(0==n&&(snap=k(e,grid_snap),pox=snap.x,poy=snap.y,(wallStartConstruc=T.nearWall(snap,12))&&(pox=wallStartConstruc.x,poy=wallStartConstruc.y)),n=1),"edit_door_mode"==r&&(n=1,$("#lin").css("cursor","pointer")),"select_mode"==r)if("undefined"==typeof binder||"segment"!=binder.type&&"node"!=binder.type&&"obj"!=binder.type&&"boundingBox"!=binder.type)n=0,t="on",snap=k(e,grid_snap),pox=snap.xMouse,poy=snap.yMouse;else{if(r="bind_mode","obj"==binder.type&&(n=1),"boundingBox"==binder.type&&(n=1),"node"==binder.type){$("#boxScale").hide(100);var o=binder.data;pox=o.x,poy=o.y;var a={x:pox,y:poy};wallListObj=[],wallListRun=[];for(var i=WALLS.length-1;i>-1;i--)if(b(WALLS[i].start,a)||b(WALLS[i].end,a)){wallListRun.push(WALLS[i]);break}for(var s in null!=wallListRun[0].child&&(b(wallListRun[0].child.start,a)||b(wallListRun[0].child.end,a))&&wallListRun.push(wallListRun[0].child),null!=wallListRun[0].parent&&(b(wallListRun[0].parent.start,a)||b(wallListRun[0].parent.end,a))&&wallListRun.push(wallListRun[0].parent),wallListRun)if(b(wallListRun[s].start,a)||b(wallListRun[s].end,a)){var l=wallListRun[s].start;b(wallListRun[s].start,a)&&(l=wallListRun[s].end),g=T.objFromWall(wallListRun[s]),h=wallListRun[s];for(var d=0;d<g.length;d++){var c=g[d],u=qSVG.measure(c,l);wallListObj.push({wall:h,from:l,distance:u,obj:c,indexObj:d})}}n=1}if("segment"==binder.type){$("#boxScale").hide(100);var h=binder.wall;if(binder.before=binder.wall.start,equation2=T.createEquationFromWall(h),null!=h.parent){equation1=T.createEquationFromWall(h.parent);var p=qSVG.angleBetweenEquations(equation1.A,equation2.A);if(p<20||p>160){var m=!0;for(var s in WALLS)if(qSVG.rayCasting(h.start,WALLS[s].coords)&&!b(WALLS[s],h.parent)&&!b(WALLS[s],h)){null!=h.parent.parent&&b(h,h.parent.parent)&&(h.parent.parent=null),null!=h.parent.child&&b(h,h.parent.child)&&(h.parent.child=null),h.parent=null,m=!1;break}m&&(b(h.parent.end,h.start,"1")?(f=new T.wall(h.parent.end,h.start,"normal",h.thick),WALLS.push(f),f.parent=h.parent,f.child=h,h.parent.child=f,h.parent=f,equation1=qSVG.perpendicularEquation(equation2,h.start.x,h.start.y)):b(h.parent.start,h.start,"2")&&(f=new T.wall(h.parent.start,h.start,"normal",h.thick),WALLS.push(f),f.parent=h.parent,f.child=h,h.parent.parent=f,h.parent=f,equation1=qSVG.perpendicularEquation(equation2,h.start.x,h.start.y)))}}if(null==h.parent){var y=!1;for(var s in WALLS)if(qSVG.rayCasting(h.start,WALLS[s].coords)&&!b(WALLS[s].coords,h.coords)){if((L=qSVG.angleBetweenEquations(WALLS[s].equations.base.A,equation2.A))<20||L>160)break;equation1=T.createEquationFromWall(WALLS[s]),equation1.follow=WALLS[s],equation1.backUp={coords:WALLS[s].coords,start:WALLS[s].start,end:WALLS[s].end,child:WALLS[s].child,parent:WALLS[s].parent},y=!0;break}y||(equation1=qSVG.perpendicularEquation(equation2,h.start.x,h.start.y))}if(null!=h.child){equation3=T.createEquationFromWall(h.child);var x=qSVG.angleBetweenEquations(equation3.A,equation2.A);if(x<20||x>160){for(var s in m=!0,WALLS)if(qSVG.rayCasting(h.end,WALLS[s].coords)&&!b(WALLS[s],h.child)&&!b(WALLS[s],h)){null!=h.child.parent&&b(h,h.child.parent)&&(h.child.parent=null),null!=h.child.child&&b(h,h.child.child)&&(h.child.child=null),h.child=null,m=!1;break}if(m)if(b(h.child.start,h.end)){var f=new T.wall(h.end,h.child.start,"new",h.thick);WALLS.push(f),f.parent=h,f.child=h.child,h.child.parent=f,h.child=f,equation3=qSVG.perpendicularEquation(equation2,h.end.x,h.end.y)}else b(h.child.end,h.end)&&(f=new T.wall(h.end,h.child.end,"normal",h.thick),WALLS.push(f),f.parent=h,f.child=h.child,h.child.child=f,h.child=f,equation3=qSVG.perpendicularEquation(equation2,h.end.x,h.end.y))}}if(null==h.child){for(var s in y=!1,WALLS)if(qSVG.rayCasting(h.end,WALLS[s].coords)&&!b(WALLS[s].coords,h.coords,"4")){var L;if((L=qSVG.angleBetweenEquations(WALLS[s].equations.base.A,equation2.A))<20||L>160)break;equation3=T.createEquationFromWall(WALLS[s]),equation3.follow=WALLS[s],equation3.backUp={coords:WALLS[s].coords,start:WALLS[s].start,end:WALLS[s].end,child:WALLS[s].child,parent:WALLS[s].parent},y=!0;break}y||(equation3=qSVG.perpendicularEquation(equation2,h.end.x,h.end.y))}for(var s in equationFollowers=[],WALLS)null==WALLS[s].child&&qSVG.rayCasting(WALLS[s].end,h.coords)&&!b(h,WALLS[s])&&equationFollowers.push({wall:WALLS[s],eq:T.createEquationFromWall(WALLS[s]),type:"end"}),null==WALLS[s].parent&&qSVG.rayCasting(WALLS[s].start,h.coords)&&!b(h,WALLS[s])&&equationFollowers.push({wall:WALLS[s],eq:T.createEquationFromWall(WALLS[s]),type:"start"});equationsObj=[];var g=T.objFromWall(h);for(d=0;d<g.length;d++)c=g[d],equationsObj.push({obj:c,wall:h,eq:qSVG.perpendicularEquation(equation2,c.x,c.y)});n=1}}}),!0),$(document).on("click","#lin",(function(e){e.preventDefault()})),document.querySelector("#panel").addEventListener("mousemove",(function(e){"line_mode"!=r&&"partition_mode"!=r||1!=n||(n=0,"undefined"!=typeof binder&&(binder.remove(),delete binder),$("#linetemp").remove(),$("#line_construc").remove(),lengthTemp.remove(),delete lengthTemp)})),window.addEventListener("resize",(function(e){i=$("#lin").width(),s=$("#lin").height(),document.querySelector("#lin").setAttribute("viewBox",d+" "+c+" "+i+" "+s)})),document.addEventListener("keydown",(function(e){"text_mode"!=r&&("37"==e.keyCode&&O("zoomleft",100,30),"38"==e.keyCode&&O("zoomtop",100,30),"39"==e.keyCode&&O("zoomright",100,30),"40"==e.keyCode&&O("zoombottom",100,30),"107"==e.keyCode&&O("zoomin",20,50),"109"==e.keyCode&&O("zoomout",20,50))}));var e,t="off",n=0,o=8,r="select_mode";taille_w=$("#lin").width(),taille_h=$("#lin").height();var a=$("#lin").offset();grid=20,showRib=!0,showArea=!0,meter=60,grid_snap="off",colorbackground="#ffffff",colorline="#fff",colorroom="#f0daaf",colorWall="#666",pox=0,poy=0,segment=0,xpath=0,ypath=0;var i=taille_w,s=taille_h,l=s/i,d=0,c=0,u=9,h=1;function p(e=!1){for(var t in e&&localStorage.removeItem("history"),WALLS)null!=WALLS[t].child&&(WALLS[t].child=WALLS.indexOf(WALLS[t].child)),null!=WALLS[t].parent&&(WALLS[t].parent=WALLS.indexOf(WALLS[t].parent));if(JSON.stringify({objData:OBJDATA,wallData:WALLS,roomData:ROOM})==HISTORY[HISTORY.length-1]){for(var t in WALLS)null!=WALLS[t].child&&(WALLS[t].child=WALLS[WALLS[t].child]),null!=WALLS[t].parent&&(WALLS[t].parent=WALLS[WALLS[t].parent]);return!1}for(var t in HISTORY.index<HISTORY.length&&(HISTORY.splice(HISTORY.index,HISTORY.length-HISTORY.index),$("#redo").addClass("disabled")),HISTORY.push(JSON.stringify({objData:OBJDATA,wallData:WALLS,roomData:ROOM})),localStorage.setItem("history",JSON.stringify(HISTORY)),HISTORY.index++,HISTORY.index>1&&$("#undo").removeClass("disabled"),WALLS)null!=WALLS[t].child&&(WALLS[t].child=WALLS[WALLS[t].child]),null!=WALLS[t].parent&&(WALLS[t].parent=WALLS[WALLS[t].parent]);return!0}function m(e=HISTORY.index,t=!1){if(0==HISTORY.length&&!t)return!1;for(var n in OBJDATA)OBJDATA[n].graph.remove();OBJDATA=[];var o=[];for(var n in o=JSON.parse(localStorage.getItem("history")),(o=JSON.parse(o[e])).objData){var r=o.objData[n],a=new T.obj2D(r.family,r.class,r.type,{x:r.x,y:r.y},r.angle,r.angleSign,r.size,r.hinge="normal",r.thick,r.value);a.limit=r.limit,OBJDATA.push(a),$("#boxcarpentry").append(OBJDATA[OBJDATA.length-1].graph),a.update()}for(var n in WALLS=o.wallData,WALLS)null!=WALLS[n].child&&(WALLS[n].child=WALLS[WALLS[n].child]),null!=WALLS[n].parent&&(WALLS[n].parent=WALLS[WALLS[n].parent]);ROOM=o.roomData,T.architect(WALLS),T.showScaleBox(),B()}function b(e,t,n=!1){n&&console.log(n);var o=!0;for(var r in e)if(e[r]!==t[r]){o=!1;break}return o}function f(e,t){var n,o;return function(){var r=this,a=+new Date,i=arguments;n&&a<n+t?(clearTimeout(o),o=setTimeout((function(){n=a,e.apply(r,i)}),t)):(n=a,e.apply(r,i))}}document.getElementById("redo").addEventListener("click",(function(){HISTORY.index<HISTORY.length&&(m(HISTORY.index),HISTORY.index++,$("#undo").removeClass("disabled"),HISTORY.index==HISTORY.length&&$("#redo").addClass("disabled"))})),document.getElementById("undo").addEventListener("click",(function(){HISTORY.index>0&&($("#undo").removeClass("disabled"),HISTORY.index-1>0&&(HISTORY.index--,m(HISTORY.index-1),$("#redo").removeClass("disabled"))),1==HISTORY.index&&$("#undo").addClass("disabled")})),$("svg").each((function(){$(this)[0].setAttribute("viewBox",d+" "+c+" "+i+" "+s)})),repListnner=function(){if("undefined"==typeof globalArea)return!1;r="report_mode",$("#panel").hide(),$("#reportTools").show(200,(function(){document.getElementById("reportTotalSurface").innerHTML="Total de la surface : <b> "+(globalArea/3600).toFixed(1)+"</b> m²",$("#reportTotalSurface").show(1e3),document.getElementById("reportNumberSurface").innerHTML="Nombre pièces : <b>"+ROOM.length+"</b>",$("#reportNumberSurface").show(1e3);var e=1,t='<div class="row">\n';for(var n in ROOM){var o="Pièce n° "+e+" <small>(sans nom)</small>";""!=ROOM[n].name&&(o=ROOM[n].name),t+='<div class="col-md-6"><p>'+o+"</p></div>\n",t+='<div class="col-md-6"><p>Surface : <b>'+(ROOM[n].area/3600).toFixed(2)+"</b> m²</p></div>\n",e++,ROOM[n].surface=(ROOM[n].area/3600).toFixed(2)}t+="</div><hr/>\n",t+="<div>\n";var r=0,a=0,i=0;for(var n in OBJDATA)"energy"==OBJDATA[n].class&&("switch"!=OBJDATA[n].type&&"doubleSwitch"!=OBJDATA[n].type&&"dimmer"!=OBJDATA[n].type||r++,"plug"!=OBJDATA[n].type&&"plug20"!=OBJDATA[n].type&&"plug32"!=OBJDATA[n].type||a++,"wallLight"!=OBJDATA[n].type&&"roofLight"!=OBJDATA[n].type||i++);t+="<p>Nombre d'interrupteur(s) :"+r+"</p>",t+="<p>Nombre de prise(s) secteur :"+a+"</p>",t+="<p>Nombre de point(s) de lumière:"+i+"</p>",t+="</div>",t+="<div>\n",t+="<h2>Répartition énergie par pièce</h2>\n",e=1,t+='<div class="row">\n',t+='<div class="col-md-4"><p>Libellé</p></div>\n',t+='<div class="col-md-2"><small>Int.</small></div>\n',t+='<div class="col-md-2"><small>Pri. sec.</small></div>\n',t+='<div class="col-md-2"><small>Pt lum.</small></div>\n',t+='<div class="col-md-2"><small>Watts Max</small></div>\n',t+="</div>";var s=[];for(var n in ROOM){t+='<div class="row">\n',o="Pièce n°"+e+" <small>(sans nom)</small>",""!=ROOM[n].name&&(o=ROOM[n].name),t+='<div class="col-md-4"><p>'+o+"</p></div>\n",r=0,a=0;var l=0,d=0,c=(i=0,0),u=!1;for(var h in OBJDATA)"energy"==OBJDATA[h].class&&("switch"!=OBJDATA[h].type&&"doubleSwitch"!=OBJDATA[h].type&&"dimmer"!=OBJDATA[h].type||(roomTarget=T.rayCastingRoom(OBJDATA[h]))&&b(ROOM[n],roomTarget)&&r++,"plug"!=OBJDATA[h].type&&"plug20"!=OBJDATA[h].type&&"plug32"!=OBJDATA[h].type||(roomTarget=T.rayCastingRoom(OBJDATA[h]))&&b(ROOM[n],roomTarget)&&(a++,"plug"!=OBJDATA[h].type||u||(c+=3520,u=!0),"plug20"==OBJDATA[h].type&&(c+=4400,l++),"plug32"==OBJDATA[h].type&&(c+=7040,d++)),"wallLight"!=OBJDATA[h].type&&"roofLight"!=OBJDATA[h].type||(roomTarget=T.rayCastingRoom(OBJDATA[h]))&&b(ROOM[n],roomTarget)&&(i++,c+=100));s.push({switch:r,plug:a,plug20:l,plug32:d,light:i}),t+='<div class="col-md-2"><b>'+r+"</b></div>\n",t+='<div class="col-md-2"><b>'+a+"</b></div>\n",t+='<div class="col-md-2"><b>'+i+"</b></div>\n",t+='<div class="col-md-2"><b>'+c+"</b></div>\n",e++,t+="</div>"}for(var n in t+="<hr/><h2>Détails Norme NF C 15-100</h2>\n",e=1,ROOM){t+='<div class="row">\n';var p=!0;if(o="Pièce n°"+e+" <small>(sans nom)</small>",""!=ROOM[n].name&&(o=ROOM[n].name),t+='<div class="col-md-4"><p>'+o+"</p></div>\n",""==ROOM[n].name)t+='<div class="col-md-8"><p><i class="fa fa-ban" aria-hidden="true" style="color:red"></i> La pièce n\'ayant pas de libellé, Home Rough Editor ne peut vous fournir d\'informations.</p></div>\n';else{if("Salon"==ROOM[n].name){for(var m in ROOM)"Salle à manger"==ROOM[m].name&&(s[n].light+=s[m].light,s[n].plug+=s[m].plug,s[n].switch+=s[m].switch);t+='<div class="col-md-8">',0==s[n].light&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux commandé</b> <small>(actuellement '+s[n].light+")</small>.</p>\n",p=!1),s[n].plug<5&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>5 prises de courant</b> <small>(actuellement '+s[n].plug+")</small>.</p>\n",p=!1),p&&(t+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),t+="</div>"}"Salle à manger"==ROOM[n].name&&(t+='<div class="col-md-8"><p><i class="fa fa-info" aria-hidden="true" style="color:blue"></i> Cette pièce est liée au <b>salon / séjour</b> selon la norme.</p></div>\n'),"Chambre"==ROOM[n].name.substr(0,7)&&(t+='<div class="col-md-8">',0==s[n].light&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux commandé</b> <small>(actuellement '+s[n].light+")</small>.</p>\n",p=!1),s[n].plug<3&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>3 prises de courant</b> <small>(actuellement '+s[n].plug+")</small>.</p>\n",p=!1),p&&(t+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),t+="</div>"),"SdB"==ROOM[n].name&&(t+='<div class="col-md-8">',0==s[n].light&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux</b> <small>(actuellement '+s[n].light+")</small>.</p>\n",p=!1),s[n].plug<2&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>2 prises de courant</b> <small>(actuellement '+s[n].plug+")</small>.</p>\n",p=!1),0==s[n].switch&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 interrupteur</b> <small>(actuellement '+s[n].switch+")</small>.</p>\n",p=!1),p&&(t+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),t+="</div>"),"Couloir"==ROOM[n].name&&(t+='<div class="col-md-8">',0==s[n].light&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux commandé</b> <small>(actuellement '+s[n].light+")</small>.</p>\n",p=!1),s[n].plug<1&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 prise de courant</b> <small>(actuellement '+s[n].plug+")</small>.</p>\n",p=!1),p&&(t+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),t+="</div>"),"Toilette"==ROOM[n].name&&(t+='<div class="col-md-8">',0==s[n].light&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux</b>. <small>(actuellement '+s[n].light+")</small>.</p>\n",p=!1),p&&(t+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),t+="</div>"),"Cuisine"==ROOM[n].name&&(t+='<div class="col-md-8">',0==s[n].light&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux commandé</b> <small>(actuellement '+s[n].light+")</small>.</p>\n",p=!1),s[n].plug<6&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>6 prise de courant</b> <small>(actuellement '+s[n].plug+")</small>.</p>\n",p=!1),0==s[n].plug32&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 prise de courant 32A</b> <small>(actuellement '+s[n].plug32+")</small>.</p>\n",p=!1),s[n].plug20<2&&(t+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>2 prise de courant 20A</b> <small>(actuellement '+s[n].plug20+")</small>.</p>\n",p=!1),p&&(t+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),t+="</div>")}e++,t+="</div>"}document.getElementById("reportRooms").innerHTML=t,$("#reportRooms").show(1e3)}))},document.getElementById("wallWidth").addEventListener("input",(function(){var e=this.value;binder.wall.thick=e,binder.wall.type="normal",T.architect(WALLS);for(var t=T.objFromWall(binder.wall),n=0;n<t.length;n++)t[n].thick=e,t[n].update();B(),document.getElementById("wallWidthVal").textContent=e})),document.getElementById("bboxTrash").addEventListener("click",(function(){binder.obj.graph.remove(),binder.graph.remove(),OBJDATA.splice(OBJDATA.indexOf(binder.obj),1),$("#objBoundingBox").hide(100),$("#panel").show(200),D("select_mode"),$("#boxinfo").html("Objet effacé"),delete binder,B()})),document.getElementById("bboxStepsAdd").addEventListener("click",(function(){var e=document.getElementById("bboxStepsVal").textContent;e<15&&(e++,binder.obj.value=e,binder.obj.update(),document.getElementById("bboxStepsVal").textContent=e)})),document.getElementById("bboxStepsMinus").addEventListener("click",(function(){var e=document.getElementById("bboxStepsVal").textContent;e>2&&(e--,binder.obj.value=e,binder.obj.update(),document.getElementById("bboxStepsVal").textContent=e)})),document.getElementById("bboxWidth").addEventListener("input",(function(){var e=this.value,t=binder.obj;t.size=e/100*meter,t.update(),binder.size=e/100*meter,binder.update(),document.getElementById("bboxWidthVal").textContent=e})),document.getElementById("bboxHeight").addEventListener("input",(function(){var e=this.value,t=binder.obj;t.thick=e/100*meter,t.update(),binder.thick=e/100*meter,binder.update(),document.getElementById("bboxHeightVal").textContent=e})),document.getElementById("bboxRotation").addEventListener("input",(function(){var e=this.value,t=binder.obj;t.angle=e,t.update(),binder.angle=e,binder.update(),document.getElementById("bboxRotationVal").textContent=e})),document.getElementById("doorWindowWidth").addEventListener("input",(function(){var e=this.value,t=binder.obj,n=T.rayCastingWalls(t,WALLS);n.length>1&&(n=n[n.length-1]);var o=q(n.equations.base,e,t);qSVG.btwn(o[1].x,n.start.x,n.end.x)&&qSVG.btwn(o[1].y,n.start.y,n.end.y)&&qSVG.btwn(o[0].x,n.start.x,n.end.x)&&qSVG.btwn(o[0].y,n.start.y,n.end.y)&&(t.size=e,t.limit=o,t.update(),binder.size=e,binder.limit=o,binder.update(),document.getElementById("doorWindowWidthVal").textContent=e),E(n)})),document.getElementById("objToolsHinge").addEventListener("click",(function(){var e=binder.obj;e.hinge="normal"==e.hinge?"reverse":"normal",e.update()})),window.addEventListener("load",(function(){document.getElementById("panel").style.transform="translateX(200px)",document.getElementById("panel").addEventListener("transitionend",(function(){document.getElementById("moveBox").style.transform="translateX(-165px)",document.getElementById("zoomBox").style.transform="translateX(-165px)"})),localStorage.getItem("history")||$("#recover").html("<p>Select a plan type."),$("#myModal").modal()})),document.getElementById("sizePolice").addEventListener("input",(function(){document.getElementById("labelBox").style.fontSize=this.value+"px"})),$("#textToLayer").on("hidden.bs.modal",(function(e){D("select_mode"),n=0;var t=document.getElementById("labelBox").textContent;""!=t&&"Votre texte"!=t?(binder=new T.obj2D("free","text",document.getElementById("labelBox").style.color,snap,0,0,0,"normal",0,{text:t,size:document.getElementById("sizePolice").value}),binder.update(),OBJDATA.push(binder),binder.graph.remove(),$("#boxText").append(OBJDATA[OBJDATA.length-1].graph),OBJDATA[OBJDATA.length-1].update(),delete binder,$("#boxinfo").html("Texte ajouté"),p()):$("#boxinfo").html("Mode sélection"),document.getElementById("labelBox").textContent="Votre texte",document.getElementById("labelBox").style.color="#333333",document.getElementById("labelBox").style.fontSize="15px",document.getElementById("sizePolice").value=15})),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),o=n.length>>>0;if(0===o)return!1;for(var r=0|t,a=Math.max(r>=0?r:o-Math.abs(r),0);a<o;){if(n[a]===e)return!0;a++}return!1}}),$("#lin").mousewheel(f((function(e){e.preventDefault(),O(e.deltaY>0?"zoomin":"zoomout",200)}),100)),document.getElementById("showRib").addEventListener("click",(function(){document.getElementById("showRib").checked?($("#boxScale").show(200),$("#boxRib").show(200),showRib=!0):($("#boxScale").hide(100),$("#boxRib").hide(100),showRib=!1)})),document.getElementById("showArea").addEventListener("click",(function(){document.getElementById("showArea").checked?$("#boxArea").show(200):$("#boxArea").hide(100)})),document.getElementById("showLayerRoom").addEventListener("click",(function(){document.getElementById("showLayerRoom").checked?$("#boxRoom").show(200):$("#boxRoom").hide(100)})),document.getElementById("showLayerEnergy").addEventListener("click",(function(){document.getElementById("showLayerEnergy").checked?$("#boxEnergy").show(200):$("#boxEnergy").hide(100)})),document.getElementById("applySurface").addEventListener("click",(function(){$("#roomTools").hide(100),$("#panel").show(200),binder.remove(),delete binder;var e=$("#roomIndex").val(),t=$("#roomBackground").val();ROOM[e].color=t;var n=$("#roomName").val();"None"==n&&(n=""),ROOM[e].name=n;var o=$("#roomSurface").val();ROOM[e].surface=o;var r=document.querySelector("#seeArea").checked;ROOM[e].showSurface=r;var a=document.querySelector("input[type=radio]:checked").value;ROOM[e].action=a,"sub"==a&&(ROOM[e].color="hatch"),"sub"!=a&&"hatch"==t&&(ROOM[e].color="gradientNeutral"),$("#boxRoom").empty(),$("#boxSurface").empty(),T.roomMaker(Rooms),$("#boxinfo").html("Pièce modifiée"),D("select_mode")})),document.getElementById("resetRoomTools").addEventListener("click",(function(){$("#roomTools").hide(100),$("#panel").show(200),binder.remove(),delete binder,$("#boxinfo").html("Pièce modifiée"),D("select_mode")})),document.getElementById("wallTrash").addEventListener("click",(function(){var e=binder.wall;for(var t in WALLS)b(WALLS[t].child,e)&&(WALLS[t].child=null),b(WALLS[t].parent,e)&&(WALLS[t].parent=null);WALLS.splice(WALLS.indexOf(e),1),$("#wallTools").hide(100),e.graph.remove(),binder.graph.remove(),T.architect(WALLS),B(),r="select_mode",$("#panel").show(200)}));for(var L=document.querySelectorAll(".textEditorColor"),g=0;g<L.length;g++)L[g].addEventListener("click",(function(){document.getElementById("labelBox").style.color=this.style.color}));var S=document.querySelectorAll(".zoom");for(g=0;g<S.length;g++)S[g].addEventListener("click",(function(){lens=this.getAttribute("data-zoom"),O(lens,200,50)}));var A=document.querySelectorAll(".roomColor");for(g=0;g<A.length;g++)A[g].addEventListener("click",(function(){var e=this.getAttribute("data-type");$("#roomBackground").val(e),binder.attr({fill:"url(#"+e+")"})}));var w=document.querySelectorAll(".objTrash");for(g=0;g<w.length;g++)w[g].addEventListener("click",(function(){$("#objTools").hide("100");var e=binder.obj;e.graph.remove(),OBJDATA.splice(OBJDATA.indexOf(e),1),D("select_mode"),$("#boxinfo").html("Mode sélection"),$("#panel").show("200"),binder.graph.remove(),delete binder,B(),$("#panel").show("300")}));var v=document.querySelectorAll(".dropdown-menu li a");for(g=0;g<v.length;g++)v[g].addEventListener("click",(function(){var e=this.textContent;$(this).parents(".btn-group").find(".dropdown-toggle").html(e+' <span class="caret"></span>'),"None"!=e?$("#roomName").val(e):$("#roomName").val("")}));function q(e,t,n,o=!1){o&&console.log(o);var r=n.x,a=n.y,i=e.A,s=e.B;if("v"==i)var l={x:r,y:a-t/2},d={x:r,y:a+t/2};else if("h"==i)l={x:r-t/2,y:a},d={x:r+t/2,y:a};else{var c=1+i*i,u=-2*r+2*i*s+-2*a*i,h=u*u-4*c*(r*r+s*s-2*a*s+a*a-t*t/4),p=(-u-Math.sqrt(h))/(2*c),m=(-u+Math.sqrt(h))/(2*c);l={x:p,y:i*p+s},d={x:m,y:i*m+s}}return[l,d]}function O(e,t,n){if("zoomout"==e&&u>1&&u<17){u--,i+=t;var o=taille_w/i;s=i*l,myDiv=document.getElementById("scaleVal"),myDiv.style.width=60*o+"px",d-=t/2,c-=t/2*l}"zoomin"==e&&u<14&&u>0&&(u++,i-=t,o=taille_w/i,s=i*l,myDiv=document.getElementById("scaleVal"),myDiv.style.width=60*o+"px",d+=t/2,c+=t/2*l),h=i/taille_w,"zoomreset"==e&&(d=0,c=0,i=taille_w,s=taille_h,h=1),"zoomright"==e&&(d+=n),"zoomleft"==e&&(d-=n),"zoomtop"==e&&(c-=n),"zoombottom"==e&&(c+=n),"zoomdrag"==e&&(d-=t,c-=n),$("svg").each((function(){$(this)[0].setAttribute("viewBox",d+" "+c+" "+i+" "+s)}))}function k(e,t){if(e.touches){var n=e.changedTouches;console.log("toto"),eX=n[0].pageX,eY=n[0].pageY,tactile=!0}else eX=e.pageX,eY=e.pageY;return x_mouse=eX*h-a.left*h+d,y_mouse=eY*h-a.top*h+c,"on"==t&&(x_grid=Math.round(x_mouse/grid)*grid,y_grid=Math.round(y_mouse/grid)*grid),"off"==t&&(x_grid=x_mouse,y_grid=y_mouse),{x:x_grid,y:y_grid,xMouse:x_mouse,yMouse:y_mouse}}function W(){"undefined"!=typeof lineIntersectionP&&(lineIntersectionP.remove(),delete lineIntersectionP)}function M(e,t=1/0,n=[""]){var o={},r={};for(o.distance=t,"undefined"!=typeof lineIntersectionP&&(lineIntersectionP.remove(),delete lineIntersectionP),lineIntersectionP=qSVG.create("boxbind","path",{d:"",stroke:"transparent","stroke-width":.5,"stroke-opacity":"1",fill:"none"}),index=0;index<WALLS.length;index++)if(-1==n.indexOf(WALLS[index])){var a=WALLS[index].start.x,i=WALLS[index].start.y,s=WALLS[index].end.x,l=WALLS[index].end.y;0==Math.abs(l-i)?(r.C="v",r.D=a,r.E="h",r.F=i,r.G="v",r.H=s,r.I="h",r.J=l):0==Math.abs(s-a)?(r.C="h",r.D=i,r.E="v",r.F=a,r.G="h",r.H=l,r.I="v",r.J=s):(r.C=(a-s)/(l-i),r.D=i-a*r.C,r.E=(l-i)/(s-a),r.F=i-a*r.E,r.G=(a-s)/(l-i),r.H=l-s*r.C,r.I=(l-i)/(s-a),r.J=l-s*r.E),r.A=r.C,r.B=r.D,eq=qSVG.nearPointOnEquation(r,e),eq.distance<o.distance&&(o.distance=eq.distance,o.node=index,o.x=eq.x,o.y=eq.y,o.x1=a,o.y1=i,o.x2=s,o.y2=l,o.way=1),r.A=r.E,r.B=r.F,eq=qSVG.nearPointOnEquation(r,e),eq.distance<o.distance&&(o.distance=eq.distance,o.node=index,o.x=eq.x,o.y=eq.y,o.x1=a,o.y1=i,o.x2=s,o.y2=l,o.way=1),r.A=r.G,r.B=r.H,eq=qSVG.nearPointOnEquation(r,e),eq.distance<o.distance&&(o.distance=eq.distance,o.node=index,o.x=eq.x,o.y=eq.y,o.x1=a,o.y1=i,o.x2=s,o.y2=l,o.way=2),r.A=r.I,r.B=r.J,eq=qSVG.nearPointOnEquation(r,e),eq.distance<o.distance&&(o.distance=eq.distance,o.node=index,o.x=eq.x,o.y=eq.y,o.x1=a,o.y1=i,o.x2=s,o.y2=l,o.way=2)}return o.distance<t&&(2==o.way?lineIntersectionP.attr({d:"M"+o.x1+","+o.y1+" L"+o.x2+","+o.y2+" L"+o.x+","+o.y,stroke:"#d7ac57"}):lineIntersectionP.attr({d:"M"+o.x2+","+o.y2+" L"+o.x1+","+o.y1+" L"+o.x+","+o.y,stroke:"#d7ac57"}),{x:o.x,y:o.y,wall:WALLS[o.node],distance:o.distance})}tactile=!1,minMoveGrid=function(e){return Math.abs(Math.abs(pox-e.x)+Math.abs(poy-e.y))},$(".visu").mouseover((function(){console.log(this.id)}));var V=[];function G(){$("#boxbind").empty(),V=[]}function E(e,t=!1){var n;t||$("#boxRib").empty(),ribMaster=[],ribMaster.push([]),ribMaster.push([]);var o=e.angle*(180/Math.PI),r=T.objFromWall(e);for(var a in ribMaster[0].push({wall:e,crossObj:!1,side:"up",coords:e.coords[0],distance:0}),ribMaster[1].push({wall:e,crossObj:!1,side:"down",coords:e.coords[1],distance:0}),r){var i=r[a];i.up=[qSVG.nearPointOnEquation(e.equations.up,i.limit[0]),qSVG.nearPointOnEquation(e.equations.up,i.limit[1])],i.down=[qSVG.nearPointOnEquation(e.equations.down,i.limit[0]),qSVG.nearPointOnEquation(e.equations.down,i.limit[1])],n=qSVG.measure(e.coords[0],i.up[0])/meter,ribMaster[0].push({wall:i,crossObj:a,side:"up",coords:i.up[0],distance:n.toFixed(2)}),n=qSVG.measure(e.coords[0],i.up[1])/meter,ribMaster[0].push({wall:i,crossObj:a,side:"up",coords:i.up[1],distance:n.toFixed(2)}),n=qSVG.measure(e.coords[1],i.down[0])/meter,ribMaster[1].push({wall:i,crossObj:a,side:"down",coords:i.down[0],distance:n.toFixed(2)}),n=qSVG.measure(e.coords[1],i.down[1])/meter,ribMaster[1].push({wall:i,crossObj:a,side:"down",coords:i.down[1],distance:n.toFixed(2)})}for(var s in n=qSVG.measure(e.coords[0],e.coords[3])/meter,ribMaster[0].push({wall:i,crossObj:!1,side:"up",coords:e.coords[3],distance:n}),n=qSVG.measure(e.coords[1],e.coords[2])/meter,ribMaster[1].push({wall:i,crossObj:!1,side:"down",coords:e.coords[2],distance:n}),ribMaster[0].sort((function(e,t){return(e.distance-t.distance).toFixed(2)})),ribMaster[1].sort((function(e,t){return(e.distance-t.distance).toFixed(2)})),ribMaster)for(var l=1;l<ribMaster[s].length;l++){var d=-5,c=Math.abs(ribMaster[s][l-1].distance-ribMaster[s][l].distance),u=o;"down"==ribMaster[s][l-1].side&&(d=10-d),(u>89||u<-89)&&(u-=180,d="down"==ribMaster[s][l-1].side?-5:10-d),V[l]=document.createElementNS("http://www.w3.org/2000/svg","text");var h=qSVG.middle(ribMaster[s][l-1].coords.x,ribMaster[s][l-1].coords.y,ribMaster[s][l].coords.x,ribMaster[s][l].coords.y);V[l].setAttributeNS(null,"x",h.x),V[l].setAttributeNS(null,"y",h.y+d),V[l].setAttributeNS(null,"text-anchor","middle"),V[l].setAttributeNS(null,"font-family","roboto"),V[l].setAttributeNS(null,"stroke","#ffffff"),V[l].textContent=c.toFixed(2),V[l].textContent<1?(V[l].setAttributeNS(null,"font-size","0.8em"),V[l].textContent=V[l].textContent.substring(1,V[l].textContent.length)):V[l].setAttributeNS(null,"font-size","1em"),V[l].setAttributeNS(null,"stroke-width","0.27px"),V[l].setAttributeNS(null,"fill","#666666"),V[l].setAttribute("transform","rotate("+u+" "+h.x+","+h.y+")"),$("#boxRib").append(V[l])}}function B(e=5){var t,n,o,r=[];for(var a in r.push([]),r.push([]),WALLS)if(WALLS[a].equations.base){for(var i in r[0].push([]),r[0][a].push({wallIndex:a,crossEdge:a,side:"up",coords:WALLS[a].coords[0],distance:0}),r[1].push([]),r[1][a].push({wallIndex:a,crossEdge:a,side:"down",coords:WALLS[a].coords[1],distance:0}),WALLS)a!=i&&WALLS[i].equations.base&&(o=qSVG.intersectionOfEquations(WALLS[a].equations.base,WALLS[i].equations.base,"object"),qSVG.btwn(o.x,WALLS[a].start.x,WALLS[a].end.x,"round")&&qSVG.btwn(o.y,WALLS[a].start.y,WALLS[a].end.y,"round")&&(t=qSVG.intersectionOfEquations(WALLS[a].equations.up,WALLS[i].equations.up,"object"),qSVG.btwn(t.x,WALLS[a].coords[0].x,WALLS[a].coords[3].x,"round")&&qSVG.btwn(t.y,WALLS[a].coords[0].y,WALLS[a].coords[3].y,"round")&&qSVG.btwn(t.x,WALLS[i].coords[0].x,WALLS[i].coords[3].x,"round")&&qSVG.btwn(t.y,WALLS[i].coords[0].y,WALLS[i].coords[3].y,"round")&&(n=qSVG.measure(WALLS[a].coords[0],t)/meter,r[0][a].push({wallIndex:a,crossEdge:i,side:"up",coords:t,distance:n.toFixed(2)})),t=qSVG.intersectionOfEquations(WALLS[a].equations.up,WALLS[i].equations.down,"object"),qSVG.btwn(t.x,WALLS[a].coords[0].x,WALLS[a].coords[3].x,"round")&&qSVG.btwn(t.y,WALLS[a].coords[0].y,WALLS[a].coords[3].y,"round")&&qSVG.btwn(t.x,WALLS[i].coords[1].x,WALLS[i].coords[2].x,"round")&&qSVG.btwn(t.y,WALLS[i].coords[1].y,WALLS[i].coords[2].y,"round")&&(n=qSVG.measure(WALLS[a].coords[0],t)/meter,r[0][a].push({wallIndex:a,crossEdge:i,side:"up",coords:t,distance:n.toFixed(2)})),t=qSVG.intersectionOfEquations(WALLS[a].equations.down,WALLS[i].equations.up,"object"),qSVG.btwn(t.x,WALLS[a].coords[1].x,WALLS[a].coords[2].x,"round")&&qSVG.btwn(t.y,WALLS[a].coords[1].y,WALLS[a].coords[2].y,"round")&&qSVG.btwn(t.x,WALLS[i].coords[0].x,WALLS[i].coords[3].x,"round")&&qSVG.btwn(t.y,WALLS[i].coords[0].y,WALLS[i].coords[3].y,"round")&&(n=qSVG.measure(WALLS[a].coords[1],t)/meter,r[1][a].push({wallIndex:a,crossEdge:i,side:"down",coords:t,distance:n.toFixed(2)})),t=qSVG.intersectionOfEquations(WALLS[a].equations.down,WALLS[i].equations.down,"object"),qSVG.btwn(t.x,WALLS[a].coords[1].x,WALLS[a].coords[2].x,"round")&&qSVG.btwn(t.y,WALLS[a].coords[1].y,WALLS[a].coords[2].y,"round")&&qSVG.btwn(t.x,WALLS[i].coords[1].x,WALLS[i].coords[2].x,"round")&&qSVG.btwn(t.y,WALLS[i].coords[1].y,WALLS[i].coords[2].y,"round")&&(n=qSVG.measure(WALLS[a].coords[1],t)/meter,r[1][a].push({wallIndex:a,crossEdge:i,side:"down",coords:t,distance:n.toFixed(2)}))));n=qSVG.measure(WALLS[a].coords[0],WALLS[a].coords[3])/meter,r[0][a].push({wallIndex:a,crossEdge:a,side:"up",coords:WALLS[a].coords[3],distance:n.toFixed(2)}),n=qSVG.measure(WALLS[a].coords[1],WALLS[a].coords[2])/meter,r[1][a].push({wallIndex:a,crossEdge:a,side:"down",coords:WALLS[a].coords[2],distance:n.toFixed(2)})}for(var s in r[0])r[0][s].sort((function(e,t){return(e.distance-t.distance).toFixed(2)}));for(var s in r[1])r[1][s].sort((function(e,t){return(e.distance-t.distance).toFixed(2)}));var l=[];for(var d in 5==e&&$("#boxRib").empty(),r)for(var s in r[d])for(var c=1;c<r[d][s].length;c++)if(r[d][s][c-1].wallIndex==r[d][s][c].wallIndex){var u=!0,h=Math.abs(r[d][s][c-1].distance-r[d][s][c].distance);if(h<.15&&(u=!1),u&&r[d][s][c-1].crossEdge==r[d][s][c].crossEdge&&r[d][s][c].crossEdge!=r[d][s][c].wallIndex&&(u=!1),u&&r[d][s].length>2&&1==c){for(var p=[],m=0;m<4;m++)p.push({x:WALLS[r[d][s][c].crossEdge].coords[m].x,y:WALLS[r[d][s][c].crossEdge].coords[m].y});qSVG.rayCasting(r[d][s][0].coords,p)&&(u=!1)}if(u&&r[d][s].length>2&&c==r[d][s].length-1){for(p=[],m=0;m<4;m++)p.push({x:WALLS[r[d][s][c-1].crossEdge].coords[m].x,y:WALLS[r[d][s][c-1].crossEdge].coords[m].y});qSVG.rayCasting(r[d][s][r[d][s].length-1].coords,p)&&(u=!1)}if(u){var b=WALLS[r[d][s][c].wallIndex].angle*(180/Math.PI),y=-e;"down"==r[d][s][c-1].side&&(y=10-y),(b>90||b<-89)&&(b-=180,y="down"==r[d][s][c-1].side?-e:10-y),l[c]=document.createElementNS("http://www.w3.org/2000/svg","text");var x=qSVG.middle(r[d][s][c-1].coords.x,r[d][s][c-1].coords.y,r[d][s][c].coords.x,r[d][s][c].coords.y);l[c].setAttributeNS(null,"x",x.x),l[c].setAttributeNS(null,"y",x.y+y),l[c].setAttributeNS(null,"text-anchor","middle"),l[c].setAttributeNS(null,"font-family","roboto"),l[c].setAttributeNS(null,"stroke","#ffffff"),l[c].textContent=h.toFixed(2),l[c].textContent<1?(l[c].setAttributeNS(null,"font-size","0.73em"),l[c].textContent=l[c].textContent.substring(1,l[c].textContent.length)):l[c].setAttributeNS(null,"font-size","0.9em"),l[c].setAttributeNS(null,"stroke-width","0.2px"),l[c].setAttributeNS(null,"fill","#555555"),l[c].setAttribute("transform","rotate("+b+" "+x.x+","+x.y+")"),$("#boxRib").append(l[c])}}}function R(e){"grab"==e&&(e="url('https://wiki.openmrs.org/s/en_GB/7502/b9217199c27dd617c8d51f6186067d7767c5001b/_/images/icons/emoticons/add.png') 8 8, auto"),"scissor"==e&&(e="url('https://maxcdn.icons8.com/windows10/PNG/64/Hands/hand_scissors-64.png'), auto"),"trash"==e&&(e="url('https://cdn4.iconfinder.com/data/icons/common-toolbar/36/Cancel-32.png'), auto"),"validation"==e&&(e="url('https://images.fatguymedia.com/wp-content/uploads/2015/09/check.png'), auto"),$("#lin").css("cursor",e)}function D(t,n){p(),$(".sub").hide(),$("#rect_mode").removeClass("btn-success"),$("#rect_mode").addClass("btn-default"),$("#select_mode").removeClass("btn-success"),$("#select_mode").addClass("btn-default"),$("#line_mode").removeClass("btn-success"),$("#line_mode").addClass("btn-default"),$("#partition_mode").removeClass("btn-success"),$("#partition_mode").addClass("btn-default"),$("#door_mode").removeClass("btn-success"),$("#door_mode").addClass("btn-default"),$("#node_mode").removeClass("btn-success"),$("#node_mode").addClass("btn-default"),$("#text_mode").removeClass("btn-success"),$("#text_mode").addClass("btn-default"),$("#room_mode").removeClass("btn-success"),$("#room_mode").addClass("btn-default"),$("#distance_mode").removeClass("btn-success"),$("#distance_mode").addClass("btn-default"),$("#object_mode").removeClass("btn-success"),$("#object_mode").addClass("btn-default"),$("#stair_mode").removeClass("btn-success"),$("#stair_mode").addClass("btn-default"),"simpleStair"!=n&&($("#"+t).removeClass("btn-default"),$("#"+t).addClass("btn-success")),r=t,e=n,"undefined"!=typeof lineIntersectionP&&(lineIntersectionP.remove(),delete lineIntersectionP)}function C(e,t,n,o,r=10){var a=[];if(a.params={},a.params.bindBox=!1,a.params.move=!1,a.params.resize=!1,a.params.resizeLimit={},a.params.resizeLimit.width={min:!1,max:!1},a.params.resizeLimit.height={min:!1,max:!1},a.params.rotate=!1,"socle"==e&&a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#5cba79",stroke:"#5cba79",strokeDashArray:""}),"doorWindow"==e&&("simple"==t&&(a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+(-n-o/2)+"  A"+n+","+n+" 0 0,1 "+n/2+","+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:40,max:120}),"double"==t&&(a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+(-n/2-o/2)+"  A"+n/2+","+n/2+" 0 0,1 0,"+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.push({path:"M "+n/2+","+-o/2+" L "+n/2+","+(-n/2-o/2)+"  A"+n/2+","+n/2+" 0 0,0 0,"+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:40,max:160}),"pocket"==t&&(a.push({path:"M "+-n/2+","+(-o/2-4)+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+(-o/2-4)+" Z",fill:"#ccc",stroke:"none",strokeDashArray:"none"}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#494646",strokeDashArray:"5 5"}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+(-o/2-5)+" L "+ +n/2+","+(-o/2-5)+" L "+ +n/2+","+-o/2+" Z",fill:"url(#hatch)",stroke:"#494646",strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:60,max:200}),"aperture"==t&&(a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#ccc",stroke:"#494646",strokeDashArray:"5,5"}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+(-n/2+5)+","+o/2+" L "+(-n/2+5)+","+-o/2+" Z",fill:"none",stroke:"#494646",strokeDashArray:"none"}),a.push({path:"M "+(n/2-5)+","+-o/2+" L "+(n/2-5)+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"none",stroke:"#494646",strokeDashArray:"none"}),a.params.resize=!0,a.params.resizeLimit.width={min:40,max:500}),"fix"==t&&(a.push({path:"M "+-n/2+",-2 L "+-n/2+",2 L "+n/2+",2 L "+n/2+",-2 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#ccc",strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:30,max:300}),"flap"==t&&(a.push({path:"M "+-n/2+",-2 L "+-n/2+",2 L "+n/2+",2 L "+n/2+",-2 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#ccc",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+(-n/2+.866*n)+","+(-n/2-o/2)+"  A"+n+","+n+" 0 0,1 "+n/2+","+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:20,max:100}),"twin"==t&&(a.push({path:"M "+-n/2+",-2 L "+-n/2+",2 L "+n/2+",2 L "+n/2+",-2 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#ccc",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+(-n/2+n/2*.866)+","+(-n/4-o/2)+"  A"+n/2+","+n/2+" 0 0,1 0,"+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.push({path:"M "+n/2+","+-o/2+" L "+(n/2+-n/2*.866)+","+(-n/4-o/2)+"  A"+n/2+","+n/2+" 0 0,0 0,"+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:40,max:200}),"bay"==t&&(a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#ccc",strokeDashArray:""}),a.push({path:"M "+-n/2+",-2 L "+-n/2+",0 L 2,0 L 2,2 L 3,2 L 3,-2 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M -2,1 L -2,3 L "+n/2+",3 L "+n/2+",1 L -1,1 L -1,-1 L -2,-1 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:60,max:300})),"measure"==e&&(a.params.bindBox=!0,a.push({path:"M-"+n/2+",0 l10,-10 l0,8 l"+(n-20)+",0 l0,-8 l10,10 l-10,10 l0,-8 l-"+(n-20)+",0 l0,8 Z",fill:"#729eeb",stroke:"none",strokeDashArray:""})),"boundingBox"==e&&a.push({path:"M"+(-n/2-10)+","+(-o/2-10)+" L"+(n/2+10)+","+(-o/2-10)+" L"+(n/2+10)+","+(o/2+10)+" L"+(-n/2-10)+","+(o/2+10)+" Z",fill:"none",stroke:"#aaa",strokeDashArray:""}),"text"==e&&(a.params.bindBox=!0,a.params.move=!0,a.params.rotate=!0,a.push({text:r.text,x:"0",y:"0",fill:t,stroke:t,fontSize:r.size+"px",strokeWidth:"0px"})),"stair"==e&&(a.params.bindBox=!0,a.params.move=!0,a.params.resize=!0,a.params.rotate=!0,a.params.width=60,a.params.height=180,"simpleStair"==t)){a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#fff",stroke:"#000",strokeDashArray:""});for(var i=o/r,s=1;s<r+1;s++)a.push({path:"M "+-n/2+","+(-o/2+s*i)+" L "+n/2+","+(-o/2+s*i),fill:"none",stroke:"#000",strokeDashArray:"none"});a.params.resizeLimit.width={min:40,max:200},a.params.resizeLimit.height={min:40,max:400}}return"energy"==e&&(a.params.bindBox=!0,a.params.move=!0,a.params.resize=!1,a.params.rotate=!1,"gtl"==t&&(a.push({path:"m -20,-20 l 40,0 l0,40 l-40,0 Z",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({text:"GTL",x:"0",y:"5",fill:"#333333",stroke:"none",fontSize:"0.9em",strokeWidth:"0.4px"}),a.params.width=40,a.params.height=40,a.family="stick"),"switch"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:qSVG.circlePath(-2,4,5),fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,0 5,-9",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"doubleSwitch"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:qSVG.circlePath(0,0,4),fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 2,-3 5,-8 3,2",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -2,3 -5,8 -3,-2",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"dimmer"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:qSVG.circlePath(-2,4,5),fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,0 5,-9",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"M -2,-6 L 10,-4 L-2,-2 Z",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"plug"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,3 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,4 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"plug20"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,3 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,4 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({text:"20A",x:"0",y:"-5",fill:"#333333",stroke:"none",fontSize:"0.65em",strokeWidth:"0.4px"}),a.params.width=36,a.params.height=36,a.family="stick"),"plug32"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,3 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,4 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({text:"32A",x:"0",y:"-5",fill:"#333333",stroke:"none",fontSize:"0.65em",strokeWidth:"0.4px"}),a.params.width=36,a.params.height=36,a.family="stick"),"roofLight"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M -8,-8 L 8,8 M -8,8 L 8,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="free"),"wallLight"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M -8,-8 L 8,8 M -8,8 L 8,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"M -10,10 L 10,10",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"www"==t&&(a.push({path:"m -20,-20 l 40,0 l0,40 l-40,0 Z",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({text:"@",x:"0",y:"4",fill:"#333333",stroke:"none",fontSize:"1.2em",strokeWidth:"0.4px"}),a.params.width=40,a.params.height=40,a.family="free"),"rj45"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"m-10,5 l0,-10 m20,0 l0,10",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,5 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,5 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({text:"RJ45",x:"0",y:"-5",fill:"#333333",stroke:"none",fontSize:"0.5em",strokeWidth:"0.4px"}),a.params.width=36,a.params.height=36,a.family="stick"),"tv"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"m-10,5 l0-10 m20,0 l0,10",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-7,-5 l0,7 l14,0 l0,-7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,5 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,5 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({text:"TV",x:"0",y:"-5",fill:"#333333",stroke:"none",fontSize:"0.5em",strokeWidth:"0.4px"}),a.params.width=36,a.params.height=36,a.family="stick"),"heater"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"m-15,-4 l30,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-14,-8 l28,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-11,-12 l22,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-16,0 l32,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-15,4 l30,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-14,8 l28,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-11,12 l22,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"radiator"==t&&(a.push({path:"m -20,-10 l 40,0 l0,20 l-40,0 Z",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M -15,-10 L -15,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M -10,-10 L -10,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M -5,-10 L -5,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M -0,-10 L -0,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M 5,-10 L 5,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M 10,-10 L 10,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M 15,-10 L 15,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.params.width=40,a.params.height=20,a.family="stick")),"furniture"==e&&(a.params.bindBox=!0,a.params.move=!0,a.params.resize=!0,a.params.rotate=!0),a}document.addEventListener("fullscreenchange",(function(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||($("#nofull_mode").display="none",$("#full_mode").show())})),$("#distance_mode").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Add a measurement"),D("distance_mode")})),$("#room_mode").click((function(){$("#lin").css("cursor","pointer"),$("#boxinfo").html("Config. of rooms"),D("room_mode")})),$("#select_mode").click((function(){$("#boxinfo").html('Mode "select"'),"undefined"!=typeof binder&&(binder.remove(),delete binder),D("select_mode")})),$("#line_mode").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Création de mur(s)"),multi=0,n=0,D("line_mode")})),$("#partition_mode").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Création de cloison(s)"),multi=0,D("partition_mode")})),$("#rect_mode").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Création de pièce(s)"),D("rect_mode")})),$(".door").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Ajouter une porte"),$("#door_list").hide(200),D("door_mode",this.id)})),$(".window").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Ajouter une fenêtre"),$("#door_list").hide(200),$("#window_list").hide(200),D("door_mode",this.id)})),$(".object").click((function(){R("move"),$("#boxinfo").html("Ajouter un objet"),D("object_mode",this.id)})),$("#stair_mode").click((function(){R("move"),$("#boxinfo").html("Ajouter un escalier"),D("object_mode","simpleStair")})),$("#node_mode").click((function(){$("#boxinfo").html('Couper un mur<br/><span style="font-size:0.7em">Attention : Couper le mur d\'une pièce peut annuler sa configuration</span>'),D("node_mode")})),$("#text_mode").click((function(){$("#boxinfo").html('Ajouter du texte<br/><span style="font-size:0.7em">Amenez le curseur à l\'endroit voulu, puis tapez votre texte.</span>'),D("text_mode")})),$("#grid_mode").click((function(){"on"==grid_snap?(grid_snap="off",$("#boxinfo").html("Grille d'aide off"),$("#grid_mode").removeClass("btn-success"),$("#grid_mode").addClass("btn-warning"),$("#grid_mode").html("GRID OFF"),$("#boxgrid").css("opacity","0.5")):(grid_snap="on",$("#boxinfo").html("Grille d'aide on"),$("#grid_mode").removeClass("btn-warning"),$("#grid_mode").addClass("btn-success"),$("#grid_mode").html('GRID ON <i class="fa fa-th" aria-hidden="true"></i>'),$("#boxgrid").css("opacity","1"))}));var T={wall:function(e,t,n,o){this.thick=o,this.start=e,this.end=t,this.type=n,this.parent=null,this.child=null,this.angle=0,this.equations={},this.coords=[],this.backUp=!1},getWallNode:function(e,t=!1){var n=[];for(var o in WALLS)b(WALLS[o],t)||(b(WALLS[o].start,e)&&n.push({wall:WALLS[o],type:"start"}),b(WALLS[o].end,e)&&n.push({wall:WALLS[o],type:"end"}));return 0!=n.length&&n},wallsComputing:function(e,t=!1){$("#boxwall").empty(),$("#boxArea").empty();for(var n=0;n<e.length;n++)null!=(o=e[n]).parent&&(b(o.parent.start,o.start)||b(o.parent.end,o.start)||(o.parent=null)),null!=o.child&&(b(o.child.start,o.end)||b(o.child.end,o.end)||(o.child=null));for(n=0;n<e.length;n++){var o;if(null!=(o=e[n]).parent){if(b(o.parent.start,o.start))var r=(l=o.parent).end,a=l.start;b(o.parent.end,o.start)&&(r=(l=o.parent).start,a=l.end)}else{var i=T.getWallNode(o.start,o);for(var s in i){var l,d=T.createEquationFromWall(i[s].wall),c=90;"move"==t&&(c=qSVG.angleBetweenEquations(d.A,equation2.A)),"start"==i[s].type&&null==i[s].wall.parent&&c>20&&c<160&&(o.parent=i[s].wall,i[s].wall.parent=o,r=(l=o.parent).end,a=l.start),"end"==i[s].type&&null==i[s].wall.child&&c>20&&c<160&&(o.parent=i[s].wall,i[s].wall.child=o,r=(l=o.parent).start,a=l.end)}}if(null!=o.child)if(b(o.child.end,o.end))var u=(m=o.child).end,h=m.start;else u=(m=o.child).start,h=m.end;else{var p=T.getWallNode(o.end,o);for(var s in p){var m;d=T.createEquationFromWall(p[s].wall),c=90,"move"==t&&(c=qSVG.angleBetweenEquations(d.A,equation2.A)),"end"==p[s].type&&null==p[s].wall.child&&c>20&&c<160&&(o.child=p[s].wall,p[s].wall.child=o,u=(m=o.child).end,h=m.start),"start"==p[s].type&&null==p[s].wall.parent&&c>20&&c<160&&(o.child=p[s].wall,p[s].wall.parent=o,u=(m=o.child).start,h=m.end)}}var y=Math.atan2(o.end.y-o.start.y,o.end.x-o.start.x);o.angle=y;var x,f=o.thick/2*Math.sin(y),L=o.thick/2*Math.cos(y),g=qSVG.createEquation(o.start.x+f,o.start.y-L,o.end.x+f,o.end.y-L),S=qSVG.createEquation(o.start.x-f,o.start.y+L,o.end.x-f,o.end.y+L),A=qSVG.createEquation(o.start.x,o.start.y,o.end.x,o.end.y);if(o.equations={up:g,down:S,base:A},null==o.parent){var w=qSVG.perpendicularEquation(g,o.start.x,o.start.y),v=qSVG.intersectionOfEquations(g,w,"object"),q=qSVG.intersectionOfEquations(S,w,"object");o.coords=[v,q],x="M"+v.x+","+v.y+" L"+q.x+","+q.y+" "}else{w=qSVG.perpendicularEquation(g,o.start.x,o.start.y);var O=Math.atan2(a.y-r.y,a.x-r.x),k=l.thick/2*Math.sin(O),W=l.thick/2*Math.cos(O),M=qSVG.createEquation(r.x+k,r.y-W,a.x+k,a.y-W),V=qSVG.createEquation(r.x-k,r.y+W,a.x-k,a.y+W);Math.abs(O-y)>.09&&(v=qSVG.intersectionOfEquations(g,M,"object"),q=qSVG.intersectionOfEquations(S,V,"object"),g.A==M.A&&(v={x:o.start.x+f,y:o.start.y-L},q={x:o.start.x-f,y:o.start.y+L}),qSVG.gap(v,{x:a.x,y:a.y})>1e3&&(v=qSVG.intersectionOfEquations(w,g,"object"),q=qSVG.intersectionOfEquations(w,S,"object"))),Math.abs(O-y)<=.09&&(v=qSVG.intersectionOfEquations(w,g,"object"),q=qSVG.intersectionOfEquations(w,S,"object")),o.coords=[v,q],x="M"+v.x+","+v.y+" L"+q.x+","+q.y+" "}if(null==o.child)w=qSVG.perpendicularEquation(g,o.end.x,o.end.y),v=qSVG.intersectionOfEquations(g,w,"object"),q=qSVG.intersectionOfEquations(S,w,"object"),o.coords.push(q,v),x=x+"L"+q.x+","+q.y+" L"+v.x+","+v.y+" Z";else{w=qSVG.perpendicularEquation(g,o.end.x,o.end.y);var G=Math.atan2(h.y-u.y,h.x-u.x),E=m.thick/2*Math.sin(G),B=m.thick/2*Math.cos(G),R=qSVG.createEquation(u.x+E,u.y-B,h.x+E,h.y-B),D=qSVG.createEquation(u.x-E,u.y+B,h.x-E,h.y+B);Math.abs(G-y)>.09&&(v=qSVG.intersectionOfEquations(g,R,"object"),q=qSVG.intersectionOfEquations(S,D,"object"),g.A==R.A&&(v={x:o.end.x+f,y:o.end.y-L},q={x:o.end.x-f,y:o.end.y+L}),qSVG.gap(v,{x:u.x,y:u.y})>1e3&&(v=qSVG.intersectionOfEquations(g,w,"object"),q=qSVG.intersectionOfEquations(S,w,"object"))),Math.abs(G-y)<=.09&&(v=qSVG.intersectionOfEquations(g,w,"object"),q=qSVG.intersectionOfEquations(S,w,"object")),o.coords.push(q,v),x=x+"L"+q.x+","+q.y+" L"+v.x+","+v.y+" Z"}o.graph=T.makeWall(x),$("#boxwall").append(o.graph)}},makeWall:function(e){return qSVG.create("none","path",{d:e,stroke:"none",fill:colorWall,"stroke-width":1,"stroke-linecap":"butt","stroke-linejoin":"miter","stroke-miterlimit":4,"fill-rule":"nonzero"})},invisibleWall:function(e=!1){return e||(e=binder.wall),0==T.objFromWall(wallBind).length?(e.type="separate",e.backUp=e.thick,e.thick=.07,T.architect(WALLS),r="select_mode",$("#panel").show(200),p(),!0):($("#boxinfo").html("Les murs contenant des portes ou des fenêtres ne peuvent être une séparation !"),!1)},visibleWall:function(e=!1){return e||(e=binder.wall),e.type="normal",e.thick=e.backUp,e.backUp=!1,T.architect(WALLS),r="select_mode",$("#panel").show(200),p(),!0},architect:function(e){return T.wallsComputing(e),Rooms=qSVG.polygonize(e),$("#boxRoom").empty(),$("#boxSurface").empty(),T.roomMaker(Rooms),!0},splitWall:function(e=!1){e||(e=binder.wall);var t=T.createEquationFromWall(e),n=qSVG.gap(e.start,e.end),o=[];for(var a in WALLS){var i=T.createEquationFromWall(WALLS[a]),s=qSVG.intersectionOfEquations(t,i,"obj");if(qSVG.btwn(s.x,binder.wall.start.x,binder.wall.end.x,"round")&&qSVG.btwn(s.y,binder.wall.start.y,binder.wall.end.y,"round")&&qSVG.btwn(s.x,WALLS[a].start.x,WALLS[a].end.x,"round")&&qSVG.btwn(s.y,WALLS[a].start.y,WALLS[a].end.y,"round")){var l=qSVG.gap(e.start,s);l>5&&l<n&&o.push({distance:l,coords:s})}}o.sort((function(e,t){return(e.distance-t.distance).toFixed(2)}));var d,c=e.start,u=e.thick;for(var a in WALLS)b(WALLS[a].child,e)&&(WALLS[a].child=null),b(WALLS[a].parent,e)&&(WALLS[a].parent=null);for(var a in WALLS.splice(WALLS.indexOf(e),1),o)d=new T.wall(c,o[a].coords,"normal",u),WALLS.push(d),d.child=WALLS[WALLS.length],c=o[a].coords;return d=new T.wall(c,e.end,"normal",u),WALLS.push(d),T.architect(WALLS),r="select_mode",$("#panel").show(200),p(),!0},nearWallNode:function(e,t=1/0,n=[""]){for(var o,r,a,i=1/0,s=0;s<WALLS.length;s++)-1==n.indexOf(WALLS[s])&&(scanStart=WALLS[s].start,scanEnd=WALLS[s].end,(a=qSVG.measure(scanStart,e))<i&&(o=scanStart,i=a,r=s),(a=qSVG.measure(scanEnd,e))<i&&(o=scanEnd,i=a,r=s));return i<=t&&{x:o.x,y:o.y,bestWall:r}},rayCastingWall:function(e){for(var t=[],n=0;n<WALLS.length;n++){for(var o=[],r=0;r<4;r++)o.push({x:WALLS[n].coords[r].x,y:WALLS[n].coords[r].y});qSVG.rayCasting(e,o)&&t.push(WALLS[n])}return 0!=t.length&&(1==t.length?t[0]:t)},stickOnWall:function(e){if(0==WALLS.length)return!1;var t=1/0,n={};if(0==WALLS.length)return!1;for(var o=0;o<WALLS.length;o++){var r=qSVG.createEquation(WALLS[o].coords[0].x,WALLS[o].coords[0].y,WALLS[o].coords[3].x,WALLS[o].coords[3].y);result1=qSVG.nearPointOnEquation(r,e);var a=qSVG.createEquation(WALLS[o].coords[1].x,WALLS[o].coords[1].y,WALLS[o].coords[2].x,WALLS[o].coords[2].y);result2=qSVG.nearPointOnEquation(a,e),result1.distance<t&&qSVG.btwn(result1.x,WALLS[o].coords[0].x,WALLS[o].coords[3].x)&&qSVG.btwn(result1.y,WALLS[o].coords[0].y,WALLS[o].coords[3].y)&&(t=result1.distance,n={wall:WALLS[o],x:result1.x,y:result1.y,distance:result1.distance}),result2.distance<t&&qSVG.btwn(result2.x,WALLS[o].coords[1].x,WALLS[o].coords[2].x)&&qSVG.btwn(result2.y,WALLS[o].coords[1].y,WALLS[o].coords[2].y)&&(t=result2.distance,n={wall:WALLS[o],x:result2.x,y:result2.y,distance:result2.distance})}var i=T.nearVertice(e);return i.distance<t&&(r=qSVG.createEquation(i.number.coords[0].x,i.number.coords[0].y,i.number.coords[3].x,i.number.coords[3].y),result1=qSVG.nearPointOnEquation(r,i),a=qSVG.createEquation(i.number.coords[1].x,i.number.coords[1].y,i.number.coords[2].x,i.number.coords[2].y),result2=qSVG.nearPointOnEquation(a,i),result1.distance<t&&qSVG.btwn(result1.x,i.number.coords[0].x,i.number.coords[3].x)&&qSVG.btwn(result1.y,i.number.coords[0].y,i.number.coords[3].y)&&(t=result1.distance,n={wall:i.number,x:result1.x,y:result1.y,distance:result1.distance}),result2.distance<t&&qSVG.btwn(result2.x,i.number.coords[1].x,i.number.coords[2].x)&&qSVG.btwn(result2.y,i.number.coords[1].y,i.number.coords[2].y)&&(t=result2.distance,n={wall:i.number,x:result2.x,y:result2.y,distance:result2.distance})),n},objFromWall:function(e,t=!1){for(var n=[],o=0;o<OBJDATA.length;o++)if("inWall"==OBJDATA[o].family){var r=qSVG.createEquation(e.start.x,e.start.y,e.end.x,e.end.y);qSVG.nearPointOnEquation(r,OBJDATA[o]).distance<.01&&qSVG.btwn(OBJDATA[o].x,e.start.x,e.end.x)&&qSVG.btwn(OBJDATA[o].y,e.start.y,e.end.y)&&n.push(OBJDATA[o])}return n},createEquationFromWall:function(e){return qSVG.createEquation(e.start.x,e.start.y,e.end.x,e.end.y)},rayCastingWalls:function(e){for(var t=[],n=0;n<WALLS.length;n++){for(var o=[],r=0;r<4;r++)o.push({x:WALLS[n].coords[r].x,y:WALLS[n].coords[r].y});qSVG.rayCasting(e,o)&&t.push(WALLS[n])}return 0!=t.length&&(1==t.length?t[0]:t)},inWallRib2:function(e,t=!1){t||$("#boxRib").empty(),ribMaster=[];var n,o=[];ribMaster.push(o),ribMaster.push(o);var r=e.angle*(180/Math.PI),a=T.objFromWall(e);for(var i in ribMaster[0].push({wall:e,crossObj:!1,side:"up",coords:e.coords[0],distance:0}),ribMaster[1].push({wall:e,crossObj:!1,side:"down",coords:e.coords[1],distance:0}),a){var s=a[i];s.up=[qSVG.nearPointOnEquation(e.equations.up,s.limit[0]),qSVG.nearPointOnEquation(e.equations.up,s.limit[1])],s.down=[qSVG.nearPointOnEquation(e.equations.down,s.limit[0]),qSVG.nearPointOnEquation(e.equations.down,s.limit[1])],n=qSVG.measure(e.coords[0],s.up[0])/meter,ribMaster[0].push({wall:e,crossObj:i,side:"up",coords:s.up[0],distance:n.toFixed(2)}),n=qSVG.measure(e.coords[0],s.up[1])/meter,ribMaster[0].push({wall:e,crossObj:i,side:"up",coords:s.up[1],distance:n.toFixed(2)}),n=qSVG.measure(e.coords[1],s.down[0])/meter,ribMaster[1].push({wall:e,crossObj:i,side:"down",coords:s.down[0],distance:n.toFixed(2)}),n=qSVG.measure(e.coords[1],s.down[1])/meter,ribMaster[1].push({wall:e,crossObj:i,side:"down",coords:s.down[1],distance:n.toFixed(2)})}for(var l in n=qSVG.measure(e.coords[0],e.coords[3])/meter,ribMaster[0].push({wall:e,crossObj:!1,side:"up",coords:e.coords[3],distance:n}),n=qSVG.measure(e.coords[1],e.coords[2])/meter,ribMaster[1].push({wall:e,crossObj:!1,side:"down",coords:e.coords[2],distance:n}),ribMaster[0].sort((function(e,t){return(e.distance-t.distance).toFixed(2)})),ribMaster[1].sort((function(e,t){return(e.distance-t.distance).toFixed(2)})),ribMaster)for(var d=1;d<ribMaster[l].length;d++){var c=-5,u=Math.abs(ribMaster[l][d-1].distance-ribMaster[l][d].distance),h=r;"down"==ribMaster[l][d-1].side&&(c=10-c),(h>89||h<-89)&&(h-=180,c="down"==ribMaster[l][d-1].side?-5:10-c),V[d]=document.createElementNS("http://www.w3.org/2000/svg","text");var p=qSVG.middle(ribMaster[l][d-1].coords.x,ribMaster[l][d-1].coords.y,ribMaster[l][d].coords.x,ribMaster[l][d].coords.y);V[d].setAttributeNS(null,"x",p.x),V[d].setAttributeNS(null,"y",p.y+c),V[d].setAttributeNS(null,"text-anchor","middle"),V[d].setAttributeNS(null,"font-family","roboto"),V[d].setAttributeNS(null,"stroke","#ffffff"),V[d].textContent=u.toFixed(2),V[d].textContent<1?(V[d].setAttributeNS(null,"font-size","0.8em"),V[d].textContent=V[d].textContent.substring(1,V[d].textContent.length)):V[d].setAttributeNS(null,"font-size","1em"),V[d].setAttributeNS(null,"stroke-width","0.4px"),V[d].setAttributeNS(null,"fill","#666666"),V[d].setAttribute("transform","rotate("+h+" "+p.x+","+p.y+")"),$("#boxRib").append(V[d])}},obj2D:function(e,t,n,o,r,i,s,l="normal",u,p){this.family=e,this.class=t,this.type=n,this.x=o.x,this.y=o.y,this.angle=r,this.angleSign=i,this.limit=[],this.hinge=l,this.graph=qSVG.create("none","g"),this.scale={x:1,y:1},this.value=p,this.size=s,this.thick=u,this.width=(this.size/meter).toFixed(2),this.height=(this.thick/meter).toFixed(2);for(var m,b=C(t,n,s,u,p),y=0;y<b.length;y++)b[y].path&&(m=qSVG.create("none","path",{d:b[y].path,"stroke-width":1,fill:b[y].fill,stroke:b[y].stroke,"stroke-dasharray":b[y].strokeDashArray})),b[y].text&&((m=qSVG.create("none","text",{x:b[y].x,y:b[y].y,"font-size":b[y].fontSize,stroke:b[y].stroke,"stroke-width":b[y].strokeWidth,"font-family":"roboto","text-anchor":"middle",fill:b[y].fill})).context.textContent=b[y].text),this.graph.append(m);var x=this.graph.get(0).getBoundingClientRect();x.x=x.x*h-a.left*h+d,x.y=x.y*h-a.top*h+c,x.origin={x:this.x,y:this.y},this.bbox=x,this.realBbox=[{x:-this.size/2,y:-this.thick/2},{x:this.size/2,y:-this.thick/2},{x:this.size/2,y:this.thick/2},{x:-this.size/2,y:this.thick/2}],"byObject"==e&&(this.family=b.family),this.params=b.params,this.size=b.params.width?b.params.width:s,this.thick=b.params.height?b.params.height:u,this.update=function(){console.log("update"),this.width=(this.size/meter).toFixed(2),this.height=(this.thick/meter).toFixed(2),b=C(this.class,this.type,this.size,this.thick,this.value);for(var e=0;e<b.length;e++)b[e].path&&this.graph.find("path")[e].setAttribute("d",b[e].path);this.graph.attr({transform:"translate("+this.x+","+this.y+") rotate("+this.angle+",0,0) scale("+("normal"==this.hinge?1:-1)+", 1)"});var t=this.graph.get(0).getBoundingClientRect();t.x=t.x*h-a.left*h+d,t.y=t.y*h-a.top*h+c,t.origin={x:this.x,y:this.y},this.bbox=t,"text"==this.class&&0==this.angle&&(this.realBbox=[{x:this.bbox.x,y:this.bbox.y},{x:this.bbox.x+this.bbox.width,y:this.bbox.y},{x:this.bbox.x+this.bbox.width,y:this.bbox.y+this.bbox.height},{x:this.bbox.x,y:this.bbox.y+this.bbox.height}],this.size=this.bbox.width,this.thick=this.bbox.height);var n=-this.angle*(Math.PI/180);this.realBbox=[{x:-this.size/2,y:-this.thick/2},{x:this.size/2,y:-this.thick/2},{x:this.size/2,y:this.thick/2},{x:-this.size/2,y:this.thick/2}];var o=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];return o[0].x=this.realBbox[0].y*Math.sin(n)+this.realBbox[0].x*Math.cos(n)+this.x,o[1].x=this.realBbox[1].y*Math.sin(n)+this.realBbox[1].x*Math.cos(n)+this.x,o[2].x=this.realBbox[2].y*Math.sin(n)+this.realBbox[2].x*Math.cos(n)+this.x,o[3].x=this.realBbox[3].y*Math.sin(n)+this.realBbox[3].x*Math.cos(n)+this.x,o[0].y=this.realBbox[0].y*Math.cos(n)-this.realBbox[0].x*Math.sin(n)+this.y,o[1].y=this.realBbox[1].y*Math.cos(n)-this.realBbox[1].x*Math.sin(n)+this.y,o[2].y=this.realBbox[2].y*Math.cos(n)-this.realBbox[2].x*Math.sin(n)+this.y,o[3].y=this.realBbox[3].y*Math.cos(n)-this.realBbox[3].x*Math.sin(n)+this.y,this.realBbox=o,!0}},roomMaker:function(e){globalArea=0,0==e.polygons.length&&(ROOM=[]);for(var t=0;t<e.polygons.length;t++){for(var n=!1,o=0;o<ROOM.length;o++){var r=e.polygons[t].coords.length,a=qSVG.diffObjIntoArray(e.polygons[t].coords,ROOM[o].coords);if(e.polygons[t].way.length==ROOM[o].way.length&&(0!=qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&0!=a||(r=0)),e.polygons[t].way.length==ROOM[o].way.length+1&&(1!=qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&2!=a||(r=0)),e.polygons[t].way.length==ROOM[o].way.length-1&&1==qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&(r=0),0==r){n=!0,ROOM[o].area=e.polygons[t].area,ROOM[o].inside=e.polygons[t].inside,ROOM[o].coords=e.polygons[t].coords,ROOM[o].coordsOutside=e.polygons[t].coordsOutside,ROOM[o].way=e.polygons[t].way,ROOM[o].coordsInside=e.polygons[t].coordsInside;break}}n||ROOM.push({coords:e.polygons[t].coords,coordsOutside:e.polygons[t].coordsOutside,coordsInside:e.polygons[t].coordsInside,inside:e.polygons[t].inside,way:e.polygons[t].way,area:e.polygons[t].area,surface:"",name:"",color:"gradientWhite",showSurface:!0,action:"add"})}var i=[];for(o=0;o<ROOM.length;o++){var s=!0;for(t=0;t<e.polygons.length;t++){var l=ROOM[o].coords.length;if(a=qSVG.diffObjIntoArray(e.polygons[t].coords,ROOM[o].coords),e.polygons[t].way.length==ROOM[o].way.length&&(0!=qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&0!=a||(l=0)),e.polygons[t].way.length==ROOM[o].way.length+1&&(1!=qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&2!=a||(l=0)),e.polygons[t].way.length==ROOM[o].way.length-1&&1==qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&(l=0),0==l){s=!0;break}s=!1}s||i.push(o)}i.sort((function(e,t){return t-e}));for(var d=0;d<i.length;d++)ROOM.splice(i[d],1);for($("#boxRoom").empty(),$("#boxSurface").empty(),$("#boxArea").empty(),o=0;o<ROOM.length;o++){"add"==ROOM[o].action&&(globalArea+=ROOM[o].area);for(var c=ROOM[o].coords,u="M"+c[0].x+","+c[0].y,h=1;h<c.length;h++)u=u+" L"+c[h].x+","+c[h].y;if(ROOM[o].inside.length>0)for(var p=0;p<ROOM[o].inside.length;p++){u=u+" M"+e.polygons[ROOM[o].inside[p]].coords[e.polygons[ROOM[o].inside[p]].coords.length-1].x+","+e.polygons[ROOM[o].inside[p]].coords[e.polygons[ROOM[o].inside[p]].coords.length-1].y;for(var m=e.polygons[ROOM[o].inside[p]].coords.length-2;m>-1;m--)u=u+" L"+e.polygons[ROOM[o].inside[p]].coords[m].x+","+e.polygons[ROOM[o].inside[p]].coords[m].y}qSVG.create("boxRoom","path",{d:u,fill:"url(#"+ROOM[o].color+")","fill-opacity":1,stroke:"none","fill-rule":"evenodd",class:"room"}),qSVG.create("boxSurface","path",{d:u,fill:"#fff","fill-opacity":1,stroke:"none","fill-rule":"evenodd",class:"room"});var b=qSVG.polygonVisualCenter(ROOM[o]);if(""!=ROOM[o].name){var y={color:"#343938"};"gradientBlack"!=ROOM[o].color&&"gradientBlue"!=ROOM[o].color||(y.color="white"),qSVG.textOnDiv(ROOM[o].name,b,y,"boxArea")}""!=ROOM[o].name&&(b.y=b.y+20);var x=(ROOM[o].area/(meter*meter)).toFixed(2)+" m²";y={color:"#343938",fontSize:"12.5px",fontWeight:"normal"},""!=ROOM[o].surface&&(y.fontWeight="bold",x=ROOM[o].surface+" m²"),"gradientBlack"!=ROOM[o].color&&"gradientBlue"!=ROOM[o].color||(y.color="white"),ROOM[o].showSurface&&qSVG.textOnDiv(x,b,y,"boxArea")}globalArea<=0?(globalArea=0,$("#areaValue").html("")):$("#areaValue").html('<i class="fa fa-map-o" aria-hidden="true"></i> '+(globalArea/3600).toFixed(1)+" m²")},rayCastingRoom:function(e){for(var t=[],n=0;n<ROOM.length;n++)qSVG.rayCasting(e,ROOM[n].coords)&&t.push(n);if(t.length>0){for(var o,r=ROOM[t[0]].area,a=0;a<t.length;a++)ROOM[t[a]].area<=r&&(r=ROOM[t[a]].area,o=ROOM[t[a]]);return o}return!1},nearVertice:function(e,t=1e4){for(var n,o=1/0,r=0;r<WALLS.length;r++){var a=qSVG.gap(e,{x:WALLS[r].start.x,y:WALLS[r].start.y}),i=qSVG.gap(e,{x:WALLS[r].end.x,y:WALLS[r].end.y});a<i&&a<o&&(o=a,n={number:WALLS[r],x:WALLS[r].start.x,y:WALLS[r].start.y,distance:Math.sqrt(o)}),i<a&&i<o&&(o=i,n={number:WALLS[r],x:WALLS[r].end.x,y:WALLS[r].end.y,distance:Math.sqrt(o)})}return o<t*t&&n},nearWall:function(e,t=1/0){var n,o=1/0,r={};if(0==WALLS.length)return!1;for(var a=0;a<WALLS.length;a++){var i=qSVG.createEquation(WALLS[a].start.x,WALLS[a].start.y,WALLS[a].end.x,WALLS[a].end.y);(n=qSVG.nearPointOnEquation(i,e)).distance<o&&qSVG.btwn(n.x,WALLS[a].start.x,WALLS[a].end.x)&&qSVG.btwn(n.y,WALLS[a].start.y,WALLS[a].end.y)&&(o=n.distance,r={wall:WALLS[a],x:n.x,y:n.y,distance:n.distance})}var s=T.nearVertice(e);return s.distance<o&&(o=s.distance,r={wall:s.number,x:s.x,y:s.y,distance:s.distance}),o<=t&&r},showScaleBox:function(){if(ROOM.length>0){for(var e,t,n,o,r=0;r<WALLS.length;r++){var a=WALLS[r].start.x,i=WALLS[r].start.y;(!r||a<e)&&(e=a),(!r||i<t)&&(t=i),(!r||a>n)&&(n=a),(!r||i>o)&&(o=i),a=WALLS[r].end.x,i=WALLS[r].end.y,(!r||a<e)&&(e=a),(!r||i<t)&&(t=i),(!r||a>n)&&(n=a),(!r||i>o)&&(o=i)}var s,l=n-e,d=o-t,c=((n-e)/meter).toFixed(2),u=((o-t)/meter).toFixed(2),h="m"+(n+40)+","+t;h=(h+=" l60,0 m-40,10 l10,-10 l10,10 m-10,-10")+" l0,"+d,h=(h+=" m-30,0 l60,0 m-40,-10 l10,10 l10,-10")+"M"+e+","+(t-40),h=(h+=" l0,-60 m10,40 l-10,-10 l10,-10 m-10,10")+" l"+l+",0",h+=" m0,30 l0,-60 m-10,40 l10,-10 l-10,-10",$("#boxScale").empty(),qSVG.create("boxScale","path",{d:h,stroke:"#555",fill:"none","stroke-width":.3,"stroke-linecap":"butt","stroke-linejoin":"miter","stroke-miterlimit":4,"fill-rule":"nonzero"}),(s=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttributeNS(null,"x",n+70),s.setAttributeNS(null,"y",(o+t)/2+35),s.setAttributeNS(null,"fill","#555"),s.setAttributeNS(null,"text-anchor","middle"),s.textContent=u+" m",s.setAttribute("transform","rotate(270 "+(n+70)+","+(o+t)/2+")"),$("#boxScale").append(s),(s=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttributeNS(null,"x",(n+e)/2),s.setAttributeNS(null,"y",t-95),s.setAttributeNS(null,"fill","#555"),s.setAttributeNS(null,"text-anchor","middle"),s.textContent=c+" m",$("#boxScale").append(s)}}}}),100);var e={wall:function(e,t,n,o){this.thick=o,this.start=e,this.end=t,this.type=n,this.parent=null,this.child=null,this.angle=0,this.equations={},this.coords=[],this.backUp=!1},getWallNode:function(e,t=!1){var n=[];for(var o in WALLS)m(WALLS[o],t)||(m(WALLS[o].start,e)&&n.push({wall:WALLS[o],type:"start"}),m(WALLS[o].end,e)&&n.push({wall:WALLS[o],type:"end"}));return 0!=n.length&&n},wallsComputing:function(t,n=!1){$("#boxwall").empty(),$("#boxArea").empty();for(var o=0;o<t.length;o++)null!=(r=t[o]).parent&&(m(r.parent.start,r.start)||m(r.parent.end,r.start)||(r.parent=null)),null!=r.child&&(m(r.child.start,r.end)||m(r.child.end,r.end)||(r.child=null));for(o=0;o<t.length;o++){var r;if(null!=(r=t[o]).parent){if(m(r.parent.start,r.start))var a=(d=r.parent).end,i=d.start;m(r.parent.end,r.start)&&(a=(d=r.parent).start,i=d.end)}else{var s=e.getWallNode(r.start,r);for(var l in s){var d,c=e.createEquationFromWall(s[l].wall),u=90;"move"==n&&(u=qSVG.angleBetweenEquations(c.A,equation2.A)),"start"==s[l].type&&null==s[l].wall.parent&&u>20&&u<160&&(r.parent=s[l].wall,s[l].wall.parent=r,a=(d=r.parent).end,i=d.start),"end"==s[l].type&&null==s[l].wall.child&&u>20&&u<160&&(r.parent=s[l].wall,s[l].wall.child=r,a=(d=r.parent).start,i=d.end)}}if(null!=r.child)if(m(r.child.end,r.end))var h=(y=r.child).end,p=y.start;else h=(y=r.child).start,p=y.end;else{var b=e.getWallNode(r.end,r);for(var l in b){var y;c=e.createEquationFromWall(b[l].wall),u=90,"move"==n&&(u=qSVG.angleBetweenEquations(c.A,equation2.A)),"end"==b[l].type&&null==b[l].wall.child&&u>20&&u<160&&(r.child=b[l].wall,b[l].wall.child=r,h=(y=r.child).end,p=y.start),"start"==b[l].type&&null==b[l].wall.parent&&u>20&&u<160&&(r.child=b[l].wall,b[l].wall.parent=r,h=(y=r.child).start,p=y.end)}}var x=Math.atan2(r.end.y-r.start.y,r.end.x-r.start.x);r.angle=x;var f,L=r.thick/2*Math.sin(x),g=r.thick/2*Math.cos(x),S=qSVG.createEquation(r.start.x+L,r.start.y-g,r.end.x+L,r.end.y-g),A=qSVG.createEquation(r.start.x-L,r.start.y+g,r.end.x-L,r.end.y+g),w=qSVG.createEquation(r.start.x,r.start.y,r.end.x,r.end.y);if(r.equations={up:S,down:A,base:w},null==r.parent){var v=qSVG.perpendicularEquation(S,r.start.x,r.start.y),q=qSVG.intersectionOfEquations(S,v,"object"),O=qSVG.intersectionOfEquations(A,v,"object");r.coords=[q,O],f="M"+q.x+","+q.y+" L"+O.x+","+O.y+" "}else{v=qSVG.perpendicularEquation(S,r.start.x,r.start.y);var k=Math.atan2(i.y-a.y,i.x-a.x),W=d.thick/2*Math.sin(k),M=d.thick/2*Math.cos(k),V=qSVG.createEquation(a.x+W,a.y-M,i.x+W,i.y-M),G=qSVG.createEquation(a.x-W,a.y+M,i.x-W,i.y+M);Math.abs(k-x)>.09&&(q=qSVG.intersectionOfEquations(S,V,"object"),O=qSVG.intersectionOfEquations(A,G,"object"),S.A==V.A&&(q={x:r.start.x+L,y:r.start.y-g},O={x:r.start.x-L,y:r.start.y+g}),qSVG.gap(q,{x:i.x,y:i.y})>1e3&&(q=qSVG.intersectionOfEquations(v,S,"object"),O=qSVG.intersectionOfEquations(v,A,"object"))),Math.abs(k-x)<=.09&&(q=qSVG.intersectionOfEquations(v,S,"object"),O=qSVG.intersectionOfEquations(v,A,"object")),r.coords=[q,O],f="M"+q.x+","+q.y+" L"+O.x+","+O.y+" "}if(null==r.child)v=qSVG.perpendicularEquation(S,r.end.x,r.end.y),q=qSVG.intersectionOfEquations(S,v,"object"),O=qSVG.intersectionOfEquations(A,v,"object"),r.coords.push(O,q),f=f+"L"+O.x+","+O.y+" L"+q.x+","+q.y+" Z";else{v=qSVG.perpendicularEquation(S,r.end.x,r.end.y);var E=Math.atan2(p.y-h.y,p.x-h.x),B=y.thick/2*Math.sin(E),R=y.thick/2*Math.cos(E),D=qSVG.createEquation(h.x+B,h.y-R,p.x+B,p.y-R),C=qSVG.createEquation(h.x-B,h.y+R,p.x-B,p.y+R);Math.abs(E-x)>.09&&(q=qSVG.intersectionOfEquations(S,D,"object"),O=qSVG.intersectionOfEquations(A,C,"object"),S.A==D.A&&(q={x:r.end.x+L,y:r.end.y-g},O={x:r.end.x-L,y:r.end.y+g}),qSVG.gap(q,{x:h.x,y:h.y})>1e3&&(q=qSVG.intersectionOfEquations(S,v,"object"),O=qSVG.intersectionOfEquations(A,v,"object"))),Math.abs(E-x)<=.09&&(q=qSVG.intersectionOfEquations(S,v,"object"),O=qSVG.intersectionOfEquations(A,v,"object")),r.coords.push(O,q),f=f+"L"+O.x+","+O.y+" L"+q.x+","+q.y+" Z"}r.graph=e.makeWall(f),$("#boxwall").append(r.graph)}},makeWall:function(e){return qSVG.create("none","path",{d:e,stroke:"none",fill:colorWall,"stroke-width":1,"stroke-linecap":"butt","stroke-linejoin":"miter","stroke-miterlimit":4,"fill-rule":"nonzero"})},invisibleWall:function(t=!1){return t||(t=binder.wall),0==e.objFromWall(wallBind).length?(t.type="separate",t.backUp=t.thick,t.thick=.07,e.architect(WALLS),$("#panel").show(200),h(),!0):($("#boxinfo").html("Les murs contenant des portes ou des fenêtres ne peuvent être une séparation !"),!1)},visibleWall:function(t=!1){return t||(t=binder.wall),t.type="normal",t.thick=t.backUp,t.backUp=!1,e.architect(WALLS),$("#panel").show(200),h(),!0},architect:function(t){return e.wallsComputing(t),Rooms=qSVG.polygonize(t),$("#boxRoom").empty(),$("#boxSurface").empty(),e.roomMaker(Rooms),!0},splitWall:function(t=!1){t||(t=binder.wall);var n=e.createEquationFromWall(t),o=qSVG.gap(t.start,t.end),r=[];for(var a in WALLS){var i=e.createEquationFromWall(WALLS[a]),s=qSVG.intersectionOfEquations(n,i,"obj");if(qSVG.btwn(s.x,binder.wall.start.x,binder.wall.end.x,"round")&&qSVG.btwn(s.y,binder.wall.start.y,binder.wall.end.y,"round")&&qSVG.btwn(s.x,WALLS[a].start.x,WALLS[a].end.x,"round")&&qSVG.btwn(s.y,WALLS[a].start.y,WALLS[a].end.y,"round")){var l=qSVG.gap(t.start,s);l>5&&l<o&&r.push({distance:l,coords:s})}}r.sort((function(e,t){return(e.distance-t.distance).toFixed(2)}));var d,c=t.start,u=t.thick;for(var a in WALLS)m(WALLS[a].child,t)&&(WALLS[a].child=null),m(WALLS[a].parent,t)&&(WALLS[a].parent=null);for(var a in WALLS.splice(WALLS.indexOf(t),1),r)d=new e.wall(c,r[a].coords,"normal",u),WALLS.push(d),d.child=WALLS[WALLS.length],c=r[a].coords;return d=new e.wall(c,t.end,"normal",u),WALLS.push(d),e.architect(WALLS),$("#panel").show(200),h(),!0},nearWallNode:function(e,t=1/0,n=[""]){for(var o,r,a,i=1/0,s=0;s<WALLS.length;s++)-1==n.indexOf(WALLS[s])&&(scanStart=WALLS[s].start,scanEnd=WALLS[s].end,(a=qSVG.measure(scanStart,e))<i&&(o=scanStart,i=a,r=s),(a=qSVG.measure(scanEnd,e))<i&&(o=scanEnd,i=a,r=s));return i<=t&&{x:o.x,y:o.y,bestWall:r}},rayCastingWall:function(e){for(var t=[],n=0;n<WALLS.length;n++){for(var o=[],r=0;r<4;r++)o.push({x:WALLS[n].coords[r].x,y:WALLS[n].coords[r].y});qSVG.rayCasting(e,o)&&t.push(WALLS[n])}return 0!=t.length&&(1==t.length?t[0]:t)},stickOnWall:function(t){if(0==WALLS.length)return!1;var n=1/0,o={};if(0==WALLS.length)return!1;for(var r=0;r<WALLS.length;r++){var a=qSVG.createEquation(WALLS[r].coords[0].x,WALLS[r].coords[0].y,WALLS[r].coords[3].x,WALLS[r].coords[3].y);result1=qSVG.nearPointOnEquation(a,t);var i=qSVG.createEquation(WALLS[r].coords[1].x,WALLS[r].coords[1].y,WALLS[r].coords[2].x,WALLS[r].coords[2].y);result2=qSVG.nearPointOnEquation(i,t),result1.distance<n&&qSVG.btwn(result1.x,WALLS[r].coords[0].x,WALLS[r].coords[3].x)&&qSVG.btwn(result1.y,WALLS[r].coords[0].y,WALLS[r].coords[3].y)&&(n=result1.distance,o={wall:WALLS[r],x:result1.x,y:result1.y,distance:result1.distance}),result2.distance<n&&qSVG.btwn(result2.x,WALLS[r].coords[1].x,WALLS[r].coords[2].x)&&qSVG.btwn(result2.y,WALLS[r].coords[1].y,WALLS[r].coords[2].y)&&(n=result2.distance,o={wall:WALLS[r],x:result2.x,y:result2.y,distance:result2.distance})}var s=e.nearVertice(t);return s.distance<n&&(a=qSVG.createEquation(s.number.coords[0].x,s.number.coords[0].y,s.number.coords[3].x,s.number.coords[3].y),result1=qSVG.nearPointOnEquation(a,s),i=qSVG.createEquation(s.number.coords[1].x,s.number.coords[1].y,s.number.coords[2].x,s.number.coords[2].y),result2=qSVG.nearPointOnEquation(i,s),result1.distance<n&&qSVG.btwn(result1.x,s.number.coords[0].x,s.number.coords[3].x)&&qSVG.btwn(result1.y,s.number.coords[0].y,s.number.coords[3].y)&&(n=result1.distance,o={wall:s.number,x:result1.x,y:result1.y,distance:result1.distance}),result2.distance<n&&qSVG.btwn(result2.x,s.number.coords[1].x,s.number.coords[2].x)&&qSVG.btwn(result2.y,s.number.coords[1].y,s.number.coords[2].y)&&(n=result2.distance,o={wall:s.number,x:result2.x,y:result2.y,distance:result2.distance})),o},objFromWall:function(e,t=!1){for(var n=[],o=0;o<OBJDATA.length;o++)if("inWall"==OBJDATA[o].family){var r=qSVG.createEquation(e.start.x,e.start.y,e.end.x,e.end.y);qSVG.nearPointOnEquation(r,OBJDATA[o]).distance<.01&&qSVG.btwn(OBJDATA[o].x,e.start.x,e.end.x)&&qSVG.btwn(OBJDATA[o].y,e.start.y,e.end.y)&&n.push(OBJDATA[o])}return n},createEquationFromWall:function(e){return qSVG.createEquation(e.start.x,e.start.y,e.end.x,e.end.y)},rayCastingWalls:function(e){for(var t=[],n=0;n<WALLS.length;n++){for(var o=[],r=0;r<4;r++)o.push({x:WALLS[n].coords[r].x,y:WALLS[n].coords[r].y});qSVG.rayCasting(e,o)&&t.push(WALLS[n])}return 0!=t.length&&(1==t.length?t[0]:t)},inWallRib2:function(t,n=!1){n||$("#boxRib").empty(),ribMaster=[];var o,r=[];ribMaster.push(r),ribMaster.push(r);var a=t.angle*(180/Math.PI),i=e.objFromWall(t);for(var s in ribMaster[0].push({wall:t,crossObj:!1,side:"up",coords:t.coords[0],distance:0}),ribMaster[1].push({wall:t,crossObj:!1,side:"down",coords:t.coords[1],distance:0}),i){var l=i[s];l.up=[qSVG.nearPointOnEquation(t.equations.up,l.limit[0]),qSVG.nearPointOnEquation(t.equations.up,l.limit[1])],l.down=[qSVG.nearPointOnEquation(t.equations.down,l.limit[0]),qSVG.nearPointOnEquation(t.equations.down,l.limit[1])],o=qSVG.measure(t.coords[0],l.up[0])/meter,ribMaster[0].push({wall:t,crossObj:s,side:"up",coords:l.up[0],distance:o.toFixed(2)}),o=qSVG.measure(t.coords[0],l.up[1])/meter,ribMaster[0].push({wall:t,crossObj:s,side:"up",coords:l.up[1],distance:o.toFixed(2)}),o=qSVG.measure(t.coords[1],l.down[0])/meter,ribMaster[1].push({wall:t,crossObj:s,side:"down",coords:l.down[0],distance:o.toFixed(2)}),o=qSVG.measure(t.coords[1],l.down[1])/meter,ribMaster[1].push({wall:t,crossObj:s,side:"down",coords:l.down[1],distance:o.toFixed(2)})}for(var d in o=qSVG.measure(t.coords[0],t.coords[3])/meter,ribMaster[0].push({wall:t,crossObj:!1,side:"up",coords:t.coords[3],distance:o}),o=qSVG.measure(t.coords[1],t.coords[2])/meter,ribMaster[1].push({wall:t,crossObj:!1,side:"down",coords:t.coords[2],distance:o}),ribMaster[0].sort((function(e,t){return(e.distance-t.distance).toFixed(2)})),ribMaster[1].sort((function(e,t){return(e.distance-t.distance).toFixed(2)})),ribMaster)for(var c=1;c<ribMaster[d].length;c++){var u=-5,h=Math.abs(ribMaster[d][c-1].distance-ribMaster[d][c].distance),p=a;"down"==ribMaster[d][c-1].side&&(u=10-u),(p>89||p<-89)&&(p-=180,u="down"==ribMaster[d][c-1].side?-5:10-u),v[c]=document.createElementNS("http://www.w3.org/2000/svg","text");var m=qSVG.middle(ribMaster[d][c-1].coords.x,ribMaster[d][c-1].coords.y,ribMaster[d][c].coords.x,ribMaster[d][c].coords.y);v[c].setAttributeNS(null,"x",m.x),v[c].setAttributeNS(null,"y",m.y+u),v[c].setAttributeNS(null,"text-anchor","middle"),v[c].setAttributeNS(null,"font-family","roboto"),v[c].setAttributeNS(null,"stroke","#ffffff"),v[c].textContent=h.toFixed(2),v[c].textContent<1?(v[c].setAttributeNS(null,"font-size","0.8em"),v[c].textContent=v[c].textContent.substring(1,v[c].textContent.length)):v[c].setAttributeNS(null,"font-size","1em"),v[c].setAttributeNS(null,"stroke-width","0.4px"),v[c].setAttributeNS(null,"fill","#666666"),v[c].setAttribute("transform","rotate("+p+" "+m.x+","+m.y+")"),$("#boxRib").append(v[c])}},obj2D:function(e,n,o,r,a,i,s,c="normal",h,p){this.family=e,this.class=n,this.type=o,this.x=r.x,this.y=r.y,this.angle=a,this.angleSign=i,this.limit=[],this.hinge=c,this.graph=qSVG.create("none","g"),this.scale={x:1,y:1},this.value=p,this.size=s,this.thick=h,this.width=(this.size/meter).toFixed(2),this.height=(this.thick/meter).toFixed(2);for(var m,b=W(n,o,s,h,p),y=0;y<b.length;y++)b[y].path&&(m=qSVG.create("none","path",{d:b[y].path,"stroke-width":1,fill:b[y].fill,stroke:b[y].stroke,"stroke-dasharray":b[y].strokeDashArray})),b[y].text&&((m=qSVG.create("none","text",{x:b[y].x,y:b[y].y,"font-size":b[y].fontSize,stroke:b[y].stroke,"stroke-width":b[y].strokeWidth,"font-family":"roboto","text-anchor":"middle",fill:b[y].fill})).context.textContent=b[y].text),this.graph.append(m);var x=this.graph.get(0).getBoundingClientRect();x.x=x.x*u-t.left*u+l,x.y=x.y*u-t.top*u+d,x.origin={x:this.x,y:this.y},this.bbox=x,this.realBbox=[{x:-this.size/2,y:-this.thick/2},{x:this.size/2,y:-this.thick/2},{x:this.size/2,y:this.thick/2},{x:-this.size/2,y:this.thick/2}],"byObject"==e&&(this.family=b.family),this.params=b.params,this.size=b.params.width?b.params.width:s,this.thick=b.params.height?b.params.height:h,this.update=function(){console.log("update"),this.width=(this.size/meter).toFixed(2),this.height=(this.thick/meter).toFixed(2),b=W(this.class,this.type,this.size,this.thick,this.value);for(var e=0;e<b.length;e++)b[e].path&&this.graph.find("path")[e].setAttribute("d",b[e].path);this.graph.attr({transform:"translate("+this.x+","+this.y+") rotate("+this.angle+",0,0) scale("+("normal"==this.hinge?1:-1)+", 1)"});var n=this.graph.get(0).getBoundingClientRect();n.x=n.x*u-t.left*u+l,n.y=n.y*u-t.top*u+d,n.origin={x:this.x,y:this.y},this.bbox=n,"text"==this.class&&0==this.angle&&(this.realBbox=[{x:this.bbox.x,y:this.bbox.y},{x:this.bbox.x+this.bbox.width,y:this.bbox.y},{x:this.bbox.x+this.bbox.width,y:this.bbox.y+this.bbox.height},{x:this.bbox.x,y:this.bbox.y+this.bbox.height}],this.size=this.bbox.width,this.thick=this.bbox.height);var o=-this.angle*(Math.PI/180);this.realBbox=[{x:-this.size/2,y:-this.thick/2},{x:this.size/2,y:-this.thick/2},{x:this.size/2,y:this.thick/2},{x:-this.size/2,y:this.thick/2}];var r=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];return r[0].x=this.realBbox[0].y*Math.sin(o)+this.realBbox[0].x*Math.cos(o)+this.x,r[1].x=this.realBbox[1].y*Math.sin(o)+this.realBbox[1].x*Math.cos(o)+this.x,r[2].x=this.realBbox[2].y*Math.sin(o)+this.realBbox[2].x*Math.cos(o)+this.x,r[3].x=this.realBbox[3].y*Math.sin(o)+this.realBbox[3].x*Math.cos(o)+this.x,r[0].y=this.realBbox[0].y*Math.cos(o)-this.realBbox[0].x*Math.sin(o)+this.y,r[1].y=this.realBbox[1].y*Math.cos(o)-this.realBbox[1].x*Math.sin(o)+this.y,r[2].y=this.realBbox[2].y*Math.cos(o)-this.realBbox[2].x*Math.sin(o)+this.y,r[3].y=this.realBbox[3].y*Math.cos(o)-this.realBbox[3].x*Math.sin(o)+this.y,this.realBbox=r,!0}},roomMaker:function(e){globalArea=0,0==e.polygons.length&&(ROOM=[]);for(var t=0;t<e.polygons.length;t++){for(var n=!1,o=0;o<ROOM.length;o++){var r=e.polygons[t].coords.length,a=qSVG.diffObjIntoArray(e.polygons[t].coords,ROOM[o].coords);if(e.polygons[t].way.length==ROOM[o].way.length&&(0!=qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&0!=a||(r=0)),e.polygons[t].way.length==ROOM[o].way.length+1&&(1!=qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&2!=a||(r=0)),e.polygons[t].way.length==ROOM[o].way.length-1&&1==qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&(r=0),0==r){n=!0,ROOM[o].area=e.polygons[t].area,ROOM[o].inside=e.polygons[t].inside,ROOM[o].coords=e.polygons[t].coords,ROOM[o].coordsOutside=e.polygons[t].coordsOutside,ROOM[o].way=e.polygons[t].way,ROOM[o].coordsInside=e.polygons[t].coordsInside;break}}n||ROOM.push({coords:e.polygons[t].coords,coordsOutside:e.polygons[t].coordsOutside,coordsInside:e.polygons[t].coordsInside,inside:e.polygons[t].inside,way:e.polygons[t].way,area:e.polygons[t].area,surface:"",name:"",color:"gradientWhite",showSurface:!0,action:"add"})}var i=[];for(o=0;o<ROOM.length;o++){var s=!0;for(t=0;t<e.polygons.length;t++){var l=ROOM[o].coords.length;if(a=qSVG.diffObjIntoArray(e.polygons[t].coords,ROOM[o].coords),e.polygons[t].way.length==ROOM[o].way.length&&(0!=qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&0!=a||(l=0)),e.polygons[t].way.length==ROOM[o].way.length+1&&(1!=qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&2!=a||(l=0)),e.polygons[t].way.length==ROOM[o].way.length-1&&1==qSVG.diffArray(e.polygons[t].way,ROOM[o].way).length&&(l=0),0==l){s=!0;break}s=!1}s||i.push(o)}i.sort((function(e,t){return t-e}));for(var d=0;d<i.length;d++)ROOM.splice(i[d],1);for($("#boxRoom").empty(),$("#boxSurface").empty(),$("#boxArea").empty(),o=0;o<ROOM.length;o++){"add"==ROOM[o].action&&(globalArea+=ROOM[o].area);for(var c=ROOM[o].coords,u="M"+c[0].x+","+c[0].y,h=1;h<c.length;h++)u=u+" L"+c[h].x+","+c[h].y;if(ROOM[o].inside.length>0)for(var p=0;p<ROOM[o].inside.length;p++){u=u+" M"+e.polygons[ROOM[o].inside[p]].coords[e.polygons[ROOM[o].inside[p]].coords.length-1].x+","+e.polygons[ROOM[o].inside[p]].coords[e.polygons[ROOM[o].inside[p]].coords.length-1].y;for(var m=e.polygons[ROOM[o].inside[p]].coords.length-2;m>-1;m--)u=u+" L"+e.polygons[ROOM[o].inside[p]].coords[m].x+","+e.polygons[ROOM[o].inside[p]].coords[m].y}qSVG.create("boxRoom","path",{d:u,fill:"url(#"+ROOM[o].color+")","fill-opacity":1,stroke:"none","fill-rule":"evenodd",class:"room"}),qSVG.create("boxSurface","path",{d:u,fill:"#fff","fill-opacity":1,stroke:"none","fill-rule":"evenodd",class:"room"});var b=qSVG.polygonVisualCenter(ROOM[o]);if(""!=ROOM[o].name){var y={color:"#343938"};"gradientBlack"!=ROOM[o].color&&"gradientBlue"!=ROOM[o].color||(y.color="white"),qSVG.textOnDiv(ROOM[o].name,b,y,"boxArea")}""!=ROOM[o].name&&(b.y=b.y+20);var x=(ROOM[o].area/(meter*meter)).toFixed(2)+" m²";y={color:"#343938",fontSize:"12.5px",fontWeight:"normal"},""!=ROOM[o].surface&&(y.fontWeight="bold",x=ROOM[o].surface+" m²"),"gradientBlack"!=ROOM[o].color&&"gradientBlue"!=ROOM[o].color||(y.color="white"),ROOM[o].showSurface&&qSVG.textOnDiv(x,b,y,"boxArea")}globalArea<=0?(globalArea=0,$("#areaValue").html("")):$("#areaValue").html('<i class="fa fa-map-o" aria-hidden="true"></i> '+(globalArea/3600).toFixed(1)+" m²")},rayCastingRoom:function(e){for(var t=[],n=0;n<ROOM.length;n++)qSVG.rayCasting(e,ROOM[n].coords)&&t.push(n);if(t.length>0){for(var o,r=ROOM[t[0]].area,a=0;a<t.length;a++)ROOM[t[a]].area<=r&&(r=ROOM[t[a]].area,o=ROOM[t[a]]);return o}return!1},nearVertice:function(e,t=1e4){for(var n,o=1/0,r=0;r<WALLS.length;r++){var a=qSVG.gap(e,{x:WALLS[r].start.x,y:WALLS[r].start.y}),i=qSVG.gap(e,{x:WALLS[r].end.x,y:WALLS[r].end.y});a<i&&a<o&&(o=a,n={number:WALLS[r],x:WALLS[r].start.x,y:WALLS[r].start.y,distance:Math.sqrt(o)}),i<a&&i<o&&(o=i,n={number:WALLS[r],x:WALLS[r].end.x,y:WALLS[r].end.y,distance:Math.sqrt(o)})}return o<t*t&&n},nearWall:function(t,n=1/0){var o,r=1/0,a={};if(0==WALLS.length)return!1;for(var i=0;i<WALLS.length;i++){var s=qSVG.createEquation(WALLS[i].start.x,WALLS[i].start.y,WALLS[i].end.x,WALLS[i].end.y);(o=qSVG.nearPointOnEquation(s,t)).distance<r&&qSVG.btwn(o.x,WALLS[i].start.x,WALLS[i].end.x)&&qSVG.btwn(o.y,WALLS[i].start.y,WALLS[i].end.y)&&(r=o.distance,a={wall:WALLS[i],x:o.x,y:o.y,distance:o.distance})}var l=e.nearVertice(t);return l.distance<r&&(r=l.distance,a={wall:l.number,x:l.x,y:l.y,distance:l.distance}),r<=n&&a},showScaleBox:function(){if(ROOM.length>0){for(var e,t,n,o,r=0;r<WALLS.length;r++){var a=WALLS[r].start.x,i=WALLS[r].start.y;(!r||a<e)&&(e=a),(!r||i<t)&&(t=i),(!r||a>n)&&(n=a),(!r||i>o)&&(o=i),a=WALLS[r].end.x,i=WALLS[r].end.y,(!r||a<e)&&(e=a),(!r||i<t)&&(t=i),(!r||a>n)&&(n=a),(!r||i>o)&&(o=i)}var s,l=n-e,d=o-t,c=((n-e)/meter).toFixed(2),u=((o-t)/meter).toFixed(2),h="m"+(n+40)+","+t;h=(h+=" l60,0 m-40,10 l10,-10 l10,10 m-10,-10")+" l0,"+d,h=(h+=" m-30,0 l60,0 m-40,-10 l10,10 l10,-10")+"M"+e+","+(t-40),h=(h+=" l0,-60 m10,40 l-10,-10 l10,-10 m-10,10")+" l"+l+",0",h+=" m0,30 l0,-60 m-10,40 l10,-10 l-10,-10",$("#boxScale").empty(),qSVG.create("boxScale","path",{d:h,stroke:"#555",fill:"none","stroke-width":.3,"stroke-linecap":"butt","stroke-linejoin":"miter","stroke-miterlimit":4,"fill-rule":"nonzero"}),(s=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttributeNS(null,"x",n+70),s.setAttributeNS(null,"y",(o+t)/2+35),s.setAttributeNS(null,"fill","#555"),s.setAttributeNS(null,"text-anchor","middle"),s.textContent=u+" m",s.setAttribute("transform","rotate(270 "+(n+70)+","+(o+t)/2+")"),$("#boxScale").append(s),(s=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttributeNS(null,"x",(n+e)/2),s.setAttributeNS(null,"y",t-95),s.setAttributeNS(null,"fill","#555"),s.setAttributeNS(null,"text-anchor","middle"),s.textContent=c+" m",$("#boxScale").append(s)}}};WALLS=[],OBJDATA=[],ROOM=[],HISTORY=[],wallSize=20,partitionSize=8,taille_w=$("#lin").width(),taille_h=$("#lin").height();var t=$("#lin").offset();grid=20,showRib=!0,showArea=!0,meter=60,grid_snap="off",colorbackground="#ffffff",colorline="#fff",colorroom="#f0daaf",colorWall="#666",pox=0,poy=0,segment=0,xpath=0,ypath=0;var n,o,r,a=taille_w,i=taille_h,s=i/a,l=0,d=0,c=9,u=1;function h(e=!1){for(var t in e&&localStorage.removeItem("history"),WALLS)null!=WALLS[t].child&&(WALLS[t].child=WALLS.indexOf(WALLS[t].child)),null!=WALLS[t].parent&&(WALLS[t].parent=WALLS.indexOf(WALLS[t].parent));if(JSON.stringify({objData:OBJDATA,wallData:WALLS,roomData:ROOM})==HISTORY[HISTORY.length-1]){for(var t in WALLS)null!=WALLS[t].child&&(WALLS[t].child=WALLS[WALLS[t].child]),null!=WALLS[t].parent&&(WALLS[t].parent=WALLS[WALLS[t].parent]);return!1}for(var t in HISTORY.index<HISTORY.length&&(HISTORY.splice(HISTORY.index,HISTORY.length-HISTORY.index),$("#redo").addClass("disabled")),HISTORY.push(JSON.stringify({objData:OBJDATA,wallData:WALLS,roomData:ROOM})),localStorage.setItem("history",JSON.stringify(HISTORY)),HISTORY.index++,HISTORY.index>1&&$("#undo").removeClass("disabled"),WALLS)null!=WALLS[t].child&&(WALLS[t].child=WALLS[WALLS[t].child]),null!=WALLS[t].parent&&(WALLS[t].parent=WALLS[WALLS[t].parent]);return!0}function p(t=HISTORY.index,n=!1){if(0==HISTORY.length&&!n)return!1;for(var o in OBJDATA)OBJDATA[o].graph.remove();OBJDATA=[];var r=[];for(var o in r=JSON.parse(localStorage.getItem("history")),(r=JSON.parse(r[t])).objData){var a=r.objData[o],i=new e.obj2D(a.family,a.class,a.type,{x:a.x,y:a.y},a.angle,a.angleSign,a.size,a.hinge="normal",a.thick,a.value);i.limit=a.limit,OBJDATA.push(i),$("#boxcarpentry").append(OBJDATA[OBJDATA.length-1].graph),i.update()}for(var o in WALLS=r.wallData,WALLS)null!=WALLS[o].child&&(WALLS[o].child=WALLS[WALLS[o].child]),null!=WALLS[o].parent&&(WALLS[o].parent=WALLS[WALLS[o].parent]);ROOM=r.roomData,e.architect(WALLS),e.showScaleBox(),q()}function m(e,t,n=!1){n&&console.log(n);var o=!0;for(var r in e)if(e[r]!==t[r]){o=!1;break}return o}document.getElementById("redo").addEventListener("click",(function(){HISTORY.index<HISTORY.length&&(p(HISTORY.index),HISTORY.index++,$("#undo").removeClass("disabled"),HISTORY.index==HISTORY.length&&$("#redo").addClass("disabled"))})),document.getElementById("undo").addEventListener("click",(function(){HISTORY.index>0&&($("#undo").removeClass("disabled"),HISTORY.index-1>0&&(HISTORY.index--,p(HISTORY.index-1),$("#redo").removeClass("disabled"))),1==HISTORY.index&&$("#undo").addClass("disabled")})),$("svg").each((function(){$(this)[0].setAttribute("viewBox",l+" "+d+" "+a+" "+i)})),document.getElementById("report_mode").addEventListener("click",(function(){if("undefined"==typeof globalArea)return!1;$("#panel").hide(),$("#reportTools").show(200,(function(){document.getElementById("reportTotalSurface").innerHTML="Total de la surface : <b>"+(globalArea/3600).toFixed(1)+"</b> m²",$("#reportTotalSurface").show(1e3),document.getElementById("reportNumberSurface").innerHTML="Nombre pièces : <b>"+ROOM.length+"</b>",$("#reportNumberSurface").show(1e3);var t=1,n='<div class="row">\n';for(var o in ROOM){var r="Pièce n°"+t+" <small>(sans nom)</small>";""!=ROOM[o].name&&(r=ROOM[o].name),n+='<div class="col-md-6"><p>'+r+"</p></div>\n",n+='<div class="col-md-6"><p>Surface : <b>'+(ROOM[o].area/3600).toFixed(2)+"</b> m²</p></div>\n",t++}n+="</div><hr/>\n",n+="<div>\n";var a=0,i=0,s=0;for(var o in OBJDATA)"energy"==OBJDATA[o].class&&("switch"!=OBJDATA[o].type&&"doubleSwitch"!=OBJDATA[o].type&&"dimmer"!=OBJDATA[o].type||a++,"plug"!=OBJDATA[o].type&&"plug20"!=OBJDATA[o].type&&"plug32"!=OBJDATA[o].type||i++,"wallLight"!=OBJDATA[o].type&&"roofLight"!=OBJDATA[o].type||s++);n+="<p>Nombre d'interrupteur(s) : "+a+"</p>",n+="<p>Nombre de prise(s) secteur : "+i+"</p>",n+="<p>Nombre de point(s) de lumière : "+s+"</p>",n+="</div>",n+="<div>\n",n+="<h2>Répartition énergie par pièce</h2>\n",t=1,n+='<div class="row">\n',n+='<div class="col-md-4"><p>Libellé</p></div>\n',n+='<div class="col-md-2"><small>Int.</small></div>\n',n+='<div class="col-md-2"><small>Pri. sec.</small></div>\n',n+='<div class="col-md-2"><small>Pt lum.</small></div>\n',n+='<div class="col-md-2"><small>Watts Max</small></div>\n',n+="</div>";var l=[];for(var o in ROOM){n+='<div class="row">\n',r="Pièce n°"+t+" <small>(sans nom)</small>",""!=ROOM[o].name&&(r=ROOM[o].name),n+='<div class="col-md-4"><p>'+r+"</p></div>\n",a=0,i=0;var d=0,c=0,u=(s=0,0),h=!1;for(var p in OBJDATA)"energy"==OBJDATA[p].class&&("switch"!=OBJDATA[p].type&&"doubleSwitch"!=OBJDATA[p].type&&"dimmer"!=OBJDATA[p].type||(roomTarget=e.rayCastingRoom(OBJDATA[p]))&&m(ROOM[o],roomTarget)&&a++,"plug"!=OBJDATA[p].type&&"plug20"!=OBJDATA[p].type&&"plug32"!=OBJDATA[p].type||(roomTarget=e.rayCastingRoom(OBJDATA[p]))&&m(ROOM[o],roomTarget)&&(i++,"plug"!=OBJDATA[p].type||h||(u+=3520,h=!0),"plug20"==OBJDATA[p].type&&(u+=4400,d++),"plug32"==OBJDATA[p].type&&(u+=7040,c++)),"wallLight"!=OBJDATA[p].type&&"roofLight"!=OBJDATA[p].type||(roomTarget=e.rayCastingRoom(OBJDATA[p]))&&m(ROOM[o],roomTarget)&&(s++,u+=100));l.push({switch:a,plug:i,plug20:d,plug32:c,light:s}),n+='<div class="col-md-2"><b>'+a+"</b></div>\n",n+='<div class="col-md-2"><b>'+i+"</b></div>\n",n+='<div class="col-md-2"><b>'+s+"</b></div>\n",n+='<div class="col-md-2"><b>'+u+"</b></div>\n",t++,n+="</div>"}for(var o in n+="<hr/><h2>Détails Norme NF C 15-100</h2>\n",t=1,ROOM){n+='<div class="row">\n';var b=!0;if(r="Pièce n°"+t+" <small>(sans nom)</small>",""!=ROOM[o].name&&(r=ROOM[o].name),n+='<div class="col-md-4"><p>'+r+"</p></div>\n",""==ROOM[o].name)n+='<div class="col-md-8"><p><i class="fa fa-ban" aria-hidden="true" style="color:red"></i> La pièce n\'ayant pas de libellé, Home Rough Editor ne peut vous fournir d\'informations.</p></div>\n';else{if("Salon"==ROOM[o].name){for(var y in ROOM)"Salle à manger"==ROOM[y].name&&(l[o].light+=l[y].light,l[o].plug+=l[y].plug,l[o].switch+=l[y].switch);n+='<div class="col-md-8">',0==l[o].light&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux commandé</b> <small>(actuellement '+l[o].light+")</small>.</p>\n",b=!1),l[o].plug<5&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>5 prises de courant</b> <small>(actuellement '+l[o].plug+")</small>.</p>\n",b=!1),b&&(n+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),n+="</div>"}"Salle à manger"==ROOM[o].name&&(n+='<div class="col-md-8"><p><i class="fa fa-info" aria-hidden="true" style="color:blue"></i> Cette pièce est liée au <b>salon / séjour</b> selon la norme.</p></div>\n'),"Chambre"==ROOM[o].name.substr(0,7)&&(n+='<div class="col-md-8">',0==l[o].light&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux commandé</b> <small>(actuellement '+l[o].light+")</small>.</p>\n",b=!1),l[o].plug<3&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>3 prises de courant</b> <small>(actuellement '+l[o].plug+")</small>.</p>\n",b=!1),b&&(n+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),n+="</div>"),"SdB"==ROOM[o].name&&(n+='<div class="col-md-8">',0==l[o].light&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux</b> <small>(actuellement '+l[o].light+")</small>.</p>\n",b=!1),l[o].plug<2&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>2 prises de courant</b> <small>(actuellement '+l[o].plug+")</small>.</p>\n",b=!1),0==l[o].switch&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 interrupteur</b> <small>(actuellement '+l[o].switch+")</small>.</p>\n",b=!1),b&&(n+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),n+="</div>"),"Couloir"==ROOM[o].name&&(n+='<div class="col-md-8">',0==l[o].light&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux commandé</b> <small>(actuellement '+l[o].light+")</small>.</p>\n",b=!1),l[o].plug<1&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 prise de courant</b> <small>(actuellement '+l[o].plug+")</small>.</p>\n",b=!1),b&&(n+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),n+="</div>"),"Toilette"==ROOM[o].name&&(n+='<div class="col-md-8">',0==l[o].light&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux</b>. <small>(actuellement '+l[o].light+")</small>.</p>\n",b=!1),b&&(n+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),n+="</div>"),"Cuisine"==ROOM[o].name&&(n+='<div class="col-md-8">',0==l[o].light&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 point lumineux commandé</b> <small>(actuellement '+l[o].light+")</small>.</p>\n",b=!1),l[o].plug<6&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>6 prise de courant</b> <small>(actuellement '+l[o].plug+")</small>.</p>\n",b=!1),0==l[o].plug32&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>1 prise de courant 32A</b> <small>(actuellement '+l[o].plug32+")</small>.</p>\n",b=!1),l[o].plug20<2&&(n+='<p><i class="fa fa-exclamation-triangle" style="color:orange" aria-hidden="true"></i> Cette pièce doit disposer d\'au moins <b>2 prise de courant 20A</b> <small>(actuellement '+l[o].plug20+")</small>.</p>\n",b=!1),b&&(n+='<i class="fa fa-check" aria-hidden="true" style="color:green"></i>'),n+="</div>")}t++,n+="</div>"}document.getElementById("reportRooms").innerHTML=n,$("#reportRooms").show(1e3)}))})),document.getElementById("wallWidth").addEventListener("input",(function(){var t=this.value;binder.wall.thick=t,binder.wall.type="normal",e.architect(WALLS);for(var n=e.objFromWall(binder.wall),o=0;o<n.length;o++)n[o].thick=t,n[o].update();q(),document.getElementById("wallWidthVal").textContent=t})),document.getElementById("bboxTrash").addEventListener("click",(function(){binder.obj.graph.remove(),binder.graph.remove(),OBJDATA.splice(OBJDATA.indexOf(binder.obj),1),$("#objBoundingBox").hide(100),$("#panel").show(200),k("select_mode"),$("#boxinfo").html("Objet effacé"),delete binder,q()})),document.getElementById("bboxStepsAdd").addEventListener("click",(function(){var e=document.getElementById("bboxStepsVal").textContent;e<15&&(e++,binder.obj.value=e,binder.obj.update(),document.getElementById("bboxStepsVal").textContent=e)})),document.getElementById("bboxStepsMinus").addEventListener("click",(function(){var e=document.getElementById("bboxStepsVal").textContent;e>2&&(e--,binder.obj.value=e,binder.obj.update(),document.getElementById("bboxStepsVal").textContent=e)})),document.getElementById("bboxWidth").addEventListener("input",(function(){var e=this.value,t=binder.obj;t.size=e/100*meter,t.update(),binder.size=e/100*meter,binder.update(),document.getElementById("bboxWidthVal").textContent=e})),document.getElementById("bboxHeight").addEventListener("input",(function(){var e=this.value,t=binder.obj;t.thick=e/100*meter,t.update(),binder.thick=e/100*meter,binder.update(),document.getElementById("bboxHeightVal").textContent=e})),document.getElementById("bboxRotation").addEventListener("input",(function(){var e=this.value,t=binder.obj;t.angle=e,t.update(),binder.angle=e,binder.update(),document.getElementById("bboxRotationVal").textContent=e})),document.getElementById("doorWindowWidth").addEventListener("input",(function(){var t=this.value,n=binder.obj,o=e.rayCastingWalls(n,WALLS);o.length>1&&(o=o[o.length-1]);var r=function(e,t,n,o=!1){o&&console.log(o);var r=n.x,a=n.y,i=e.A,s=e.B;if("v"==i)var l={x:r,y:a-t/2},d={x:r,y:a+t/2};else if("h"==i)l={x:r-t/2,y:a},d={x:r+t/2,y:a};else{var c=1+i*i,u=-2*r+2*i*s+-2*a*i,h=u*u-4*c*(r*r+s*s-2*a*s+a*a-t*t/4),p=(-u-Math.sqrt(h))/(2*c),m=(-u+Math.sqrt(h))/(2*c);l={x:p,y:i*p+s},d={x:m,y:i*m+s}}return[l,d]}(o.equations.base,t,n);qSVG.btwn(r[1].x,o.start.x,o.end.x)&&qSVG.btwn(r[1].y,o.start.y,o.end.y)&&qSVG.btwn(r[0].x,o.start.x,o.end.x)&&qSVG.btwn(r[0].y,o.start.y,o.end.y)&&(n.size=t,n.limit=r,n.update(),binder.size=t,binder.limit=r,binder.update(),document.getElementById("doorWindowWidthVal").textContent=t),function(t,n=!1){var o;n||$("#boxRib").empty(),ribMaster=[],ribMaster.push([]),ribMaster.push([]);var r=t.angle*(180/Math.PI),a=e.objFromWall(t);for(var i in ribMaster[0].push({wall:t,crossObj:!1,side:"up",coords:t.coords[0],distance:0}),ribMaster[1].push({wall:t,crossObj:!1,side:"down",coords:t.coords[1],distance:0}),a){var s=a[i];s.up=[qSVG.nearPointOnEquation(t.equations.up,s.limit[0]),qSVG.nearPointOnEquation(t.equations.up,s.limit[1])],s.down=[qSVG.nearPointOnEquation(t.equations.down,s.limit[0]),qSVG.nearPointOnEquation(t.equations.down,s.limit[1])],o=qSVG.measure(t.coords[0],s.up[0])/meter,ribMaster[0].push({wall:s,crossObj:i,side:"up",coords:s.up[0],distance:o.toFixed(2)}),o=qSVG.measure(t.coords[0],s.up[1])/meter,ribMaster[0].push({wall:s,crossObj:i,side:"up",coords:s.up[1],distance:o.toFixed(2)}),o=qSVG.measure(t.coords[1],s.down[0])/meter,ribMaster[1].push({wall:s,crossObj:i,side:"down",coords:s.down[0],distance:o.toFixed(2)}),o=qSVG.measure(t.coords[1],s.down[1])/meter,ribMaster[1].push({wall:s,crossObj:i,side:"down",coords:s.down[1],distance:o.toFixed(2)})}for(var l in o=qSVG.measure(t.coords[0],t.coords[3])/meter,ribMaster[0].push({wall:s,crossObj:!1,side:"up",coords:t.coords[3],distance:o}),o=qSVG.measure(t.coords[1],t.coords[2])/meter,ribMaster[1].push({wall:s,crossObj:!1,side:"down",coords:t.coords[2],distance:o}),ribMaster[0].sort((function(e,t){return(e.distance-t.distance).toFixed(2)})),ribMaster[1].sort((function(e,t){return(e.distance-t.distance).toFixed(2)})),ribMaster)for(var d=1;d<ribMaster[l].length;d++){var c=-5,u=Math.abs(ribMaster[l][d-1].distance-ribMaster[l][d].distance),h=r;"down"==ribMaster[l][d-1].side&&(c=10-c),(h>89||h<-89)&&(h-=180,c="down"==ribMaster[l][d-1].side?-5:10-c),v[d]=document.createElementNS("http://www.w3.org/2000/svg","text");var p=qSVG.middle(ribMaster[l][d-1].coords.x,ribMaster[l][d-1].coords.y,ribMaster[l][d].coords.x,ribMaster[l][d].coords.y);v[d].setAttributeNS(null,"x",p.x),v[d].setAttributeNS(null,"y",p.y+c),v[d].setAttributeNS(null,"text-anchor","middle"),v[d].setAttributeNS(null,"font-family","roboto"),v[d].setAttributeNS(null,"stroke","#ffffff"),v[d].textContent=u.toFixed(2),v[d].textContent<1?(v[d].setAttributeNS(null,"font-size","0.8em"),v[d].textContent=v[d].textContent.substring(1,v[d].textContent.length)):v[d].setAttributeNS(null,"font-size","1em"),v[d].setAttributeNS(null,"stroke-width","0.27px"),v[d].setAttributeNS(null,"fill","#666666"),v[d].setAttribute("transform","rotate("+h+" "+p.x+","+p.y+")"),$("#boxRib").append(v[d])}}(o)})),document.getElementById("objToolsHinge").addEventListener("click",(function(){var e=binder.obj;e.hinge="normal"==e.hinge?"reverse":"normal",e.update()})),window.addEventListener("load",(function(){document.getElementById("panel").style.transform="translateX(200px)",document.getElementById("panel").addEventListener("transitionend",(function(){document.getElementById("moveBox").style.transform="translateX(-165px)",document.getElementById("zoomBox").style.transform="translateX(-165px)"})),localStorage.getItem("history")||$("#recover").html("<p>Select a plan type."),$("#myModal").modal()})),document.getElementById("sizePolice").addEventListener("input",(function(){document.getElementById("labelBox").style.fontSize=this.value+"px"})),$("#textToLayer").on("hidden.bs.modal",(function(t){k("select_mode");var n=document.getElementById("labelBox").textContent;""!=n&&"Votre texte"!=n?(binder=new e.obj2D("free","text",document.getElementById("labelBox").style.color,snap,0,0,0,"normal",0,{text:n,size:document.getElementById("sizePolice").value}),binder.update(),OBJDATA.push(binder),binder.graph.remove(),$("#boxText").append(OBJDATA[OBJDATA.length-1].graph),OBJDATA[OBJDATA.length-1].update(),delete binder,$("#boxinfo").html("Texte ajouté"),h()):$("#boxinfo").html("Mode sélection"),document.getElementById("labelBox").textContent="Votre texte",document.getElementById("labelBox").style.color="#333333",document.getElementById("labelBox").style.fontSize="15px",document.getElementById("sizePolice").value=15})),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),o=n.length>>>0;if(0===o)return!1;for(var r=0|t,a=Math.max(r>=0?r:o-Math.abs(r),0);a<o;){if(n[a]===e)return!0;a++}return!1}}),$("#lin").mousewheel((n=function(e){e.preventDefault(),w(e.deltaY>0?"zoomin":"zoomout",200)},function(){var e=this,t=+new Date,a=arguments;o&&t<o+100?(clearTimeout(r),r=setTimeout((function(){o=t,n.apply(e,a)}),100)):(o=t,n.apply(e,a))})),document.getElementById("showRib").addEventListener("click",(function(){document.getElementById("showRib").checked?($("#boxScale").show(200),$("#boxRib").show(200),showRib=!0):($("#boxScale").hide(100),$("#boxRib").hide(100),showRib=!1)})),document.getElementById("showArea").addEventListener("click",(function(){document.getElementById("showArea").checked?$("#boxArea").show(200):$("#boxArea").hide(100)})),document.getElementById("showLayerRoom").addEventListener("click",(function(){document.getElementById("showLayerRoom").checked?$("#boxRoom").show(200):$("#boxRoom").hide(100)})),document.getElementById("showLayerEnergy").addEventListener("click",(function(){document.getElementById("showLayerEnergy").checked?$("#boxEnergy").show(200):$("#boxEnergy").hide(100)})),document.getElementById("applySurface").addEventListener("click",(function(){$("#roomTools").hide(100),$("#panel").show(200),binder.remove(),delete binder;var t=$("#roomIndex").val(),n=$("#roomBackground").val();ROOM[t].color=n;var o=$("#roomName").val();"None"==o&&(o=""),ROOM[t].name=o;var r=$("#roomSurface").val();ROOM[t].surface=r;var a=document.querySelector("#seeArea").checked;ROOM[t].showSurface=a;var i=document.querySelector("input[type=radio]:checked").value;ROOM[t].action=i,"sub"==i&&(ROOM[t].color="hatch"),"sub"!=i&&"hatch"==n&&(ROOM[t].color="gradientNeutral"),$("#boxRoom").empty(),$("#boxSurface").empty(),e.roomMaker(Rooms),$("#boxinfo").html("Pièce modifiée"),k("select_mode")})),document.getElementById("resetRoomTools").addEventListener("click",(function(){$("#roomTools").hide(100),$("#panel").show(200),binder.remove(),delete binder,$("#boxinfo").html("Pièce modifiée"),k("select_mode")})),document.getElementById("wallTrash").addEventListener("click",(function(){var t=binder.wall;for(var n in WALLS)m(WALLS[n].child,t)&&(WALLS[n].child=null),m(WALLS[n].parent,t)&&(WALLS[n].parent=null);WALLS.splice(WALLS.indexOf(t),1),$("#wallTools").hide(100),t.graph.remove(),binder.graph.remove(),e.architect(WALLS),q(),$("#panel").show(200)}));for(var b=document.querySelectorAll(".textEditorColor"),f=0;f<b.length;f++)b[f].addEventListener("click",(function(){document.getElementById("labelBox").style.color=this.style.color}));var L=document.querySelectorAll(".zoom");for(f=0;f<L.length;f++)L[f].addEventListener("click",(function(){lens=this.getAttribute("data-zoom"),w(lens,200,50)}));var g=document.querySelectorAll(".roomColor");for(f=0;f<g.length;f++)g[f].addEventListener("click",(function(){var e=this.getAttribute("data-type");$("#roomBackground").val(e),binder.attr({fill:"url(#"+e+")"})}));var S=document.querySelectorAll(".objTrash");for(f=0;f<S.length;f++)S[f].addEventListener("click",(function(){$("#objTools").hide("100");var e=binder.obj;e.graph.remove(),OBJDATA.splice(OBJDATA.indexOf(e),1),k("select_mode"),$("#boxinfo").html("Mode sélection"),$("#panel").show("200"),binder.graph.remove(),delete binder,q(),$("#panel").show("300")}));var A=document.querySelectorAll(".dropdown-menu li a");for(f=0;f<A.length;f++)A[f].addEventListener("click",(function(){var e=this.textContent;$(this).parents(".btn-group").find(".dropdown-toggle").html(e+' <span class="caret"></span>'),"None"!=e?$("#roomName").val(e):$("#roomName").val("")}));function w(e,t,n){if("zoomout"==e&&c>1&&c<17){c--,a+=t;var o=taille_w/a;i=a*s,myDiv=document.getElementById("scaleVal"),myDiv.style.width=60*o+"px",l-=t/2,d-=t/2*s}"zoomin"==e&&c<14&&c>0&&(c++,a-=t,o=taille_w/a,i=a*s,myDiv=document.getElementById("scaleVal"),myDiv.style.width=60*o+"px",l+=t/2,d+=t/2*s),u=a/taille_w,"zoomreset"==e&&(l=0,d=0,a=taille_w,i=taille_h,u=1),"zoomright"==e&&(l+=n),"zoomleft"==e&&(l-=n),"zoomtop"==e&&(d-=n),"zoombottom"==e&&(d+=n),"zoomdrag"==e&&(l-=t,d-=n),$("svg").each((function(){$(this)[0].setAttribute("viewBox",l+" "+d+" "+a+" "+i)}))}tactile=!1,minMoveGrid=function(e){return Math.abs(Math.abs(pox-e.x)+Math.abs(poy-e.y))},$(".visu").mouseover((function(){console.log(this.id)}));var v=[];function q(e=5){var t,n,o,r=[];for(var a in r.push([]),r.push([]),WALLS)if(WALLS[a].equations.base){for(var i in r[0].push([]),r[0][a].push({wallIndex:a,crossEdge:a,side:"up",coords:WALLS[a].coords[0],distance:0}),r[1].push([]),r[1][a].push({wallIndex:a,crossEdge:a,side:"down",coords:WALLS[a].coords[1],distance:0}),WALLS)a!=i&&WALLS[i].equations.base&&(o=qSVG.intersectionOfEquations(WALLS[a].equations.base,WALLS[i].equations.base,"object"),qSVG.btwn(o.x,WALLS[a].start.x,WALLS[a].end.x,"round")&&qSVG.btwn(o.y,WALLS[a].start.y,WALLS[a].end.y,"round")&&(t=qSVG.intersectionOfEquations(WALLS[a].equations.up,WALLS[i].equations.up,"object"),qSVG.btwn(t.x,WALLS[a].coords[0].x,WALLS[a].coords[3].x,"round")&&qSVG.btwn(t.y,WALLS[a].coords[0].y,WALLS[a].coords[3].y,"round")&&qSVG.btwn(t.x,WALLS[i].coords[0].x,WALLS[i].coords[3].x,"round")&&qSVG.btwn(t.y,WALLS[i].coords[0].y,WALLS[i].coords[3].y,"round")&&(n=qSVG.measure(WALLS[a].coords[0],t)/meter,r[0][a].push({wallIndex:a,crossEdge:i,side:"up",coords:t,distance:n.toFixed(2)})),t=qSVG.intersectionOfEquations(WALLS[a].equations.up,WALLS[i].equations.down,"object"),qSVG.btwn(t.x,WALLS[a].coords[0].x,WALLS[a].coords[3].x,"round")&&qSVG.btwn(t.y,WALLS[a].coords[0].y,WALLS[a].coords[3].y,"round")&&qSVG.btwn(t.x,WALLS[i].coords[1].x,WALLS[i].coords[2].x,"round")&&qSVG.btwn(t.y,WALLS[i].coords[1].y,WALLS[i].coords[2].y,"round")&&(n=qSVG.measure(WALLS[a].coords[0],t)/meter,r[0][a].push({wallIndex:a,crossEdge:i,side:"up",coords:t,distance:n.toFixed(2)})),t=qSVG.intersectionOfEquations(WALLS[a].equations.down,WALLS[i].equations.up,"object"),qSVG.btwn(t.x,WALLS[a].coords[1].x,WALLS[a].coords[2].x,"round")&&qSVG.btwn(t.y,WALLS[a].coords[1].y,WALLS[a].coords[2].y,"round")&&qSVG.btwn(t.x,WALLS[i].coords[0].x,WALLS[i].coords[3].x,"round")&&qSVG.btwn(t.y,WALLS[i].coords[0].y,WALLS[i].coords[3].y,"round")&&(n=qSVG.measure(WALLS[a].coords[1],t)/meter,r[1][a].push({wallIndex:a,crossEdge:i,side:"down",coords:t,distance:n.toFixed(2)})),t=qSVG.intersectionOfEquations(WALLS[a].equations.down,WALLS[i].equations.down,"object"),qSVG.btwn(t.x,WALLS[a].coords[1].x,WALLS[a].coords[2].x,"round")&&qSVG.btwn(t.y,WALLS[a].coords[1].y,WALLS[a].coords[2].y,"round")&&qSVG.btwn(t.x,WALLS[i].coords[1].x,WALLS[i].coords[2].x,"round")&&qSVG.btwn(t.y,WALLS[i].coords[1].y,WALLS[i].coords[2].y,"round")&&(n=qSVG.measure(WALLS[a].coords[1],t)/meter,r[1][a].push({wallIndex:a,crossEdge:i,side:"down",coords:t,distance:n.toFixed(2)}))));n=qSVG.measure(WALLS[a].coords[0],WALLS[a].coords[3])/meter,r[0][a].push({wallIndex:a,crossEdge:a,side:"up",coords:WALLS[a].coords[3],distance:n.toFixed(2)}),n=qSVG.measure(WALLS[a].coords[1],WALLS[a].coords[2])/meter,r[1][a].push({wallIndex:a,crossEdge:a,side:"down",coords:WALLS[a].coords[2],distance:n.toFixed(2)})}for(var s in r[0])r[0][s].sort((function(e,t){return(e.distance-t.distance).toFixed(2)}));for(var s in r[1])r[1][s].sort((function(e,t){return(e.distance-t.distance).toFixed(2)}));var l=[];for(var d in 5==e&&$("#boxRib").empty(),r)for(var s in r[d])for(var c=1;c<r[d][s].length;c++)if(r[d][s][c-1].wallIndex==r[d][s][c].wallIndex){var u=!0,h=Math.abs(r[d][s][c-1].distance-r[d][s][c].distance);if(h<.15&&(u=!1),u&&r[d][s][c-1].crossEdge==r[d][s][c].crossEdge&&r[d][s][c].crossEdge!=r[d][s][c].wallIndex&&(u=!1),u&&r[d][s].length>2&&1==c){for(var p=[],m=0;m<4;m++)p.push({x:WALLS[r[d][s][c].crossEdge].coords[m].x,y:WALLS[r[d][s][c].crossEdge].coords[m].y});qSVG.rayCasting(r[d][s][0].coords,p)&&(u=!1)}if(u&&r[d][s].length>2&&c==r[d][s].length-1){for(p=[],m=0;m<4;m++)p.push({x:WALLS[r[d][s][c-1].crossEdge].coords[m].x,y:WALLS[r[d][s][c-1].crossEdge].coords[m].y});qSVG.rayCasting(r[d][s][r[d][s].length-1].coords,p)&&(u=!1)}if(u){var b=WALLS[r[d][s][c].wallIndex].angle*(180/Math.PI),y=-e;"down"==r[d][s][c-1].side&&(y=10-y),(b>90||b<-89)&&(b-=180,y="down"==r[d][s][c-1].side?-e:10-y),l[c]=document.createElementNS("http://www.w3.org/2000/svg","text");var x=qSVG.middle(r[d][s][c-1].coords.x,r[d][s][c-1].coords.y,r[d][s][c].coords.x,r[d][s][c].coords.y);l[c].setAttributeNS(null,"x",x.x),l[c].setAttributeNS(null,"y",x.y+y),l[c].setAttributeNS(null,"text-anchor","middle"),l[c].setAttributeNS(null,"font-family","roboto"),l[c].setAttributeNS(null,"stroke","#ffffff"),l[c].textContent=h.toFixed(2),l[c].textContent<1?(l[c].setAttributeNS(null,"font-size","0.73em"),l[c].textContent=l[c].textContent.substring(1,l[c].textContent.length)):l[c].setAttributeNS(null,"font-size","0.9em"),l[c].setAttributeNS(null,"stroke-width","0.2px"),l[c].setAttributeNS(null,"fill","#555555"),l[c].setAttribute("transform","rotate("+b+" "+x.x+","+x.y+")"),$("#boxRib").append(l[c])}}}function O(e){"grab"==e&&(e="url('https://wiki.openmrs.org/s/en_GB/7502/b9217199c27dd617c8d51f6186067d7767c5001b/_/images/icons/emoticons/add.png') 8 8, auto"),"scissor"==e&&(e="url('https://maxcdn.icons8.com/windows10/PNG/64/Hands/hand_scissors-64.png'), auto"),"trash"==e&&(e="url('https://cdn4.iconfinder.com/data/icons/common-toolbar/36/Cancel-32.png'), auto"),"validation"==e&&(e="url('https://images.fatguymedia.com/wp-content/uploads/2015/09/check.png'), auto"),$("#lin").css("cursor",e)}function k(e,t){h(),$(".sub").hide(),$("#rect_mode").removeClass("btn-success"),$("#rect_mode").addClass("btn-default"),$("#select_mode").removeClass("btn-success"),$("#select_mode").addClass("btn-default"),$("#line_mode").removeClass("btn-success"),$("#line_mode").addClass("btn-default"),$("#partition_mode").removeClass("btn-success"),$("#partition_mode").addClass("btn-default"),$("#door_mode").removeClass("btn-success"),$("#door_mode").addClass("btn-default"),$("#node_mode").removeClass("btn-success"),$("#node_mode").addClass("btn-default"),$("#text_mode").removeClass("btn-success"),$("#text_mode").addClass("btn-default"),$("#room_mode").removeClass("btn-success"),$("#room_mode").addClass("btn-default"),$("#distance_mode").removeClass("btn-success"),$("#distance_mode").addClass("btn-default"),$("#object_mode").removeClass("btn-success"),$("#object_mode").addClass("btn-default"),$("#stair_mode").removeClass("btn-success"),$("#stair_mode").addClass("btn-default"),"simpleStair"!=t&&($("#"+e).removeClass("btn-default"),$("#"+e).addClass("btn-success")),"undefined"!=typeof lineIntersectionP&&(lineIntersectionP.remove(),delete lineIntersectionP)}function W(e,t,n,o,r=10){var a=[];if(a.params={},a.params.bindBox=!1,a.params.move=!1,a.params.resize=!1,a.params.resizeLimit={},a.params.resizeLimit.width={min:!1,max:!1},a.params.resizeLimit.height={min:!1,max:!1},a.params.rotate=!1,"socle"==e&&a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#5cba79",stroke:"#5cba79",strokeDashArray:""}),"doorWindow"==e&&("simple"==t&&(a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+(-n-o/2)+"  A"+n+","+n+" 0 0,1 "+n/2+","+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:40,max:120}),"double"==t&&(a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+(-n/2-o/2)+"  A"+n/2+","+n/2+" 0 0,1 0,"+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.push({path:"M "+n/2+","+-o/2+" L "+n/2+","+(-n/2-o/2)+"  A"+n/2+","+n/2+" 0 0,0 0,"+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:40,max:160}),"pocket"==t&&(a.push({path:"M "+-n/2+","+(-o/2-4)+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+(-o/2-4)+" Z",fill:"#ccc",stroke:"none",strokeDashArray:"none"}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#494646",strokeDashArray:"5 5"}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+(-o/2-5)+" L "+ +n/2+","+(-o/2-5)+" L "+ +n/2+","+-o/2+" Z",fill:"url(#hatch)",stroke:"#494646",strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:60,max:200}),"aperture"==t&&(a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#ccc",stroke:"#494646",strokeDashArray:"5,5"}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+(-n/2+5)+","+o/2+" L "+(-n/2+5)+","+-o/2+" Z",fill:"none",stroke:"#494646",strokeDashArray:"none"}),a.push({path:"M "+(n/2-5)+","+-o/2+" L "+(n/2-5)+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"none",stroke:"#494646",strokeDashArray:"none"}),a.params.resize=!0,a.params.resizeLimit.width={min:40,max:500}),"fix"==t&&(a.push({path:"M "+-n/2+",-2 L "+-n/2+",2 L "+n/2+",2 L "+n/2+",-2 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#ccc",strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:30,max:300}),"flap"==t&&(a.push({path:"M "+-n/2+",-2 L "+-n/2+",2 L "+n/2+",2 L "+n/2+",-2 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#ccc",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+(-n/2+.866*n)+","+(-n/2-o/2)+"  A"+n+","+n+" 0 0,1 "+n/2+","+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:20,max:100}),"twin"==t&&(a.push({path:"M "+-n/2+",-2 L "+-n/2+",2 L "+n/2+",2 L "+n/2+",-2 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#ccc",strokeDashArray:""}),a.push({path:"M "+-n/2+","+-o/2+" L "+(-n/2+n/2*.866)+","+(-n/4-o/2)+"  A"+n/2+","+n/2+" 0 0,1 0,"+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.push({path:"M "+n/2+","+-o/2+" L "+(n/2+-n/2*.866)+","+(-n/4-o/2)+"  A"+n/2+","+n/2+" 0 0,0 0,"+-o/2,fill:"none",stroke:colorWall,strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:40,max:200}),"bay"==t&&(a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" M "+n/2+","+o/2+" L "+n/2+","+-o/2,fill:"none",stroke:"#ccc",strokeDashArray:""}),a.push({path:"M "+-n/2+",-2 L "+-n/2+",0 L 2,0 L 2,2 L 3,2 L 3,-2 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.push({path:"M -2,1 L -2,3 L "+n/2+",3 L "+n/2+",1 L -1,1 L -1,-1 L -2,-1 Z",fill:"#ccc",stroke:"none",strokeDashArray:""}),a.params.resize=!0,a.params.resizeLimit.width={min:60,max:300})),"measure"==e&&(a.params.bindBox=!0,a.push({path:"M-"+n/2+",0 l10,-10 l0,8 l"+(n-20)+",0 l0,-8 l10,10 l-10,10 l0,-8 l-"+(n-20)+",0 l0,8 Z",fill:"#729eeb",stroke:"none",strokeDashArray:""})),"boundingBox"==e&&a.push({path:"M"+(-n/2-10)+","+(-o/2-10)+" L"+(n/2+10)+","+(-o/2-10)+" L"+(n/2+10)+","+(o/2+10)+" L"+(-n/2-10)+","+(o/2+10)+" Z",fill:"none",stroke:"#aaa",strokeDashArray:""}),"text"==e&&(a.params.bindBox=!0,a.params.move=!0,a.params.rotate=!0,a.push({text:r.text,x:"0",y:"0",fill:t,stroke:t,fontSize:r.size+"px",strokeWidth:"0px"})),"stair"==e&&(a.params.bindBox=!0,a.params.move=!0,a.params.resize=!0,a.params.rotate=!0,a.params.width=60,a.params.height=180,"simpleStair"==t)){a.push({path:"M "+-n/2+","+-o/2+" L "+-n/2+","+o/2+" L "+n/2+","+o/2+" L "+n/2+","+-o/2+" Z",fill:"#fff",stroke:"#000",strokeDashArray:""});for(var i=o/r,s=1;s<r+1;s++)a.push({path:"M "+-n/2+","+(-o/2+s*i)+" L "+n/2+","+(-o/2+s*i),fill:"none",stroke:"#000",strokeDashArray:"none"});a.params.resizeLimit.width={min:40,max:200},a.params.resizeLimit.height={min:40,max:400}}return"energy"==e&&(a.params.bindBox=!0,a.params.move=!0,a.params.resize=!1,a.params.rotate=!1,"gtl"==t&&(a.push({path:"m -20,-20 l 40,0 l0,40 l-40,0 Z",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({text:"GTL",x:"0",y:"5",fill:"#333333",stroke:"none",fontSize:"0.9em",strokeWidth:"0.4px"}),a.params.width=40,a.params.height=40,a.family="stick"),"switch"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:qSVG.circlePath(-2,4,5),fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,0 5,-9",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"doubleSwitch"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:qSVG.circlePath(0,0,4),fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 2,-3 5,-8 3,2",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -2,3 -5,8 -3,-2",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"dimmer"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:qSVG.circlePath(-2,4,5),fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,0 5,-9",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"M -2,-6 L 10,-4 L-2,-2 Z",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"plug"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,3 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,4 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"plug20"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,3 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,4 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({text:"20A",x:"0",y:"-5",fill:"#333333",stroke:"none",fontSize:"0.65em",strokeWidth:"0.4px"}),a.params.width=36,a.params.height=36,a.family="stick"),"plug32"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M 10,-6 a 10,10 0 0 1 -5,8 10,10 0 0 1 -10,0 10,10 0 0 1 -5,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,3 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,4 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({text:"32A",x:"0",y:"-5",fill:"#333333",stroke:"none",fontSize:"0.65em",strokeWidth:"0.4px"}),a.params.width=36,a.params.height=36,a.family="stick"),"roofLight"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M -8,-8 L 8,8 M -8,8 L 8,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="free"),"wallLight"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"M -8,-8 L 8,8 M -8,8 L 8,-8",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"M -10,10 L 10,10",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"www"==t&&(a.push({path:"m -20,-20 l 40,0 l0,40 l-40,0 Z",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({text:"@",x:"0",y:"4",fill:"#333333",stroke:"none",fontSize:"1.2em",strokeWidth:"0.4px"}),a.params.width=40,a.params.height=40,a.family="free"),"rj45"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"m-10,5 l0,-10 m20,0 l0,10",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,5 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,5 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({text:"RJ45",x:"0",y:"-5",fill:"#333333",stroke:"none",fontSize:"0.5em",strokeWidth:"0.4px"}),a.params.width=36,a.params.height=36,a.family="stick"),"tv"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"m-10,5 l0-10 m20,0 l0,10",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-7,-5 l0,7 l14,0 l0,-7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m 0,5 v 7",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m -10,5 h 20",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({text:"TV",x:"0",y:"-5",fill:"#333333",stroke:"none",fontSize:"0.5em",strokeWidth:"0.4px"}),a.params.width=36,a.params.height=36,a.family="stick"),"heater"==t&&(a.push({path:qSVG.circlePath(0,0,16),fill:"#fff",stroke:"#000",strokeDashArray:""}),a.push({path:"m-15,-4 l30,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-14,-8 l28,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-11,-12 l22,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-16,0 l32,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-15,4 l30,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-14,8 l28,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.push({path:"m-11,12 l22,0",fill:"none",stroke:"#333",strokeDashArray:""}),a.params.width=36,a.params.height=36,a.family="stick"),"radiator"==t&&(a.push({path:"m -20,-10 l 40,0 l0,20 l-40,0 Z",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M -15,-10 L -15,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M -10,-10 L -10,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M -5,-10 L -5,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M -0,-10 L -0,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M 5,-10 L 5,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M 10,-10 L 10,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.push({path:"M 15,-10 L 15,10",fill:"#fff",stroke:"#333",strokeDashArray:""}),a.params.width=40,a.params.height=20,a.family="stick")),"furniture"==e&&(a.params.bindBox=!0,a.params.move=!0,a.params.resize=!0,a.params.rotate=!0),a}document.addEventListener("fullscreenchange",(function(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||($("#nofull_mode").display="none",$("#full_mode").show())})),$("#distance_mode").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Add a measurement"),k("distance_mode")})),$("#room_mode").click((function(){$("#lin").css("cursor","pointer"),$("#boxinfo").html("Config. of rooms"),k("room_mode")})),$("#select_mode").click((function(){$("#boxinfo").html('Mode "select"'),"undefined"!=typeof binder&&(binder.remove(),delete binder),k("select_mode")})),$("#line_mode").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Création de mur(s)"),multi=0,k("line_mode")})),$("#partition_mode").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Création de cloison(s)"),multi=0,k("partition_mode")})),$("#rect_mode").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Création de pièce(s)"),k("rect_mode")})),$(".door").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Ajouter une porte"),$("#door_list").hide(200),k("door_mode",this.id)})),$(".window").click((function(){$("#lin").css("cursor","crosshair"),$("#boxinfo").html("Ajouter une fenêtre"),$("#door_list").hide(200),$("#window_list").hide(200),k("door_mode",this.id)})),$(".object").click((function(){O("move"),$("#boxinfo").html("Ajouter un objet"),k("object_mode",this.id)})),$("#stair_mode").click((function(){O("move"),$("#boxinfo").html("Ajouter un escalier"),k("object_mode","simpleStair")})),$("#node_mode").click((function(){$("#boxinfo").html('Couper un mur<br/><span style="font-size:0.7em">Attention : Couper le mur d\'une pièce peut annuler sa configuration</span>'),k("node_mode")})),$("#text_mode").click((function(){$("#boxinfo").html('Ajouter du texte<br/><span style="font-size:0.7em">Amenez le curseur à l\'endroit voulu, puis tapez votre texte.</span>'),k("text_mode")})),$("#grid_mode").click((function(){"on"==grid_snap?(grid_snap="off",$("#boxinfo").html("Grille d'aide off"),$("#grid_mode").removeClass("btn-success"),$("#grid_mode").addClass("btn-warning"),$("#grid_mode").html("GRID OFF"),$("#boxgrid").css("opacity","0.5")):(grid_snap="on",$("#boxinfo").html("Grille d'aide on"),$("#grid_mode").removeClass("btn-warning"),$("#grid_mode").addClass("btn-success"),$("#grid_mode").html('GRID ON <i class="fa fa-th" aria-hidden="true"></i>'),$("#boxgrid").css("opacity","1"))}))}function ReportDetails(){return console.log("ROOM details"),repListnner(),{ROOM:ROOM}}WALLS=[],OBJDATA=[],ROOM=[],HISTORY=[],wallSize=20,partitionSize=8;